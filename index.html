<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <script>
        if ( window.matchMedia( '(prefers-color-scheme: dark)' ).media === 'not all' || window.location.href.includes( "darkmode=true" ) ) {
            document.documentElement.style.display = 'none';
            document.head.insertAdjacentHTML('beforeend', '<link rel="stylesheet" href="./styles/light.css" onload="document.documentElement.style.display = \'\'">',);
        }
    </script>
    <link rel="stylesheet" href="./styles/dark.css?v=68" media="(prefers-color-scheme: dark)" />
    <link rel="stylesheet" href="./styles/light.css?v=68" media="(prefers-color-scheme: light)"/>
    <!-- The main stylesheet -->
    <link rel="stylesheet" href="./styles/style.css?v=68" />
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <link rel="manifest" href="manifest.json">
    <title>Anigma</title>
    <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
    <script src="https://supertestnet.github.io/bitcoin-chess/js/qrcode.js"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script src="https://bundle.run/bech32@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://unpkg.com/axios@0.24.0/dist/axios.min.js"></script>
    <script src="translation.js?v=68"></script>
</head>
<body>
    <!-- based on this: https://github.com/YunusEmreNalbant/css-chat-interface -->
    <script>
        function isBech32( string ) {
            try {
                var words = bech32.bech32.decode( string ).words;
                return true;
            } catch( e ) {
                return false;
            }
        }
        function pubkeyToNpub( hex ) {
            return bech32.bech32.encode( "npub", bech32.bech32.toWords( buffer.Buffer.from( hex, "hex" ) ) );
        }
        function pubkeyFromNpub( npub ) {
            return buffer.Buffer.from( bech32.bech32.fromWords( bech32.bech32.decode( npub ).words ) ).toString( "hex" );
        }
        function privkeyToNsec( hex ) {
            return bech32.bech32.encode( "nsec", bech32.bech32.toWords( buffer.Buffer.from( hex, "hex" ) ) );
        }
        function privkeyFromNsec( nsec ) {
            return buffer.Buffer.from( bech32.bech32.fromWords( bech32.bech32.decode( nsec ).words ) ).toString( "hex" );
        }
    </script>
    <script>
        admin = false;
        if ( window.location.href.includes( "admin=true" ) ) {
            var admin = true;
        }
    </script>
    <script>
        navigator.serviceWorker && navigator.serviceWorker.register( './sw.js' ).then( function( registration ) {
            //console.log( 'Excellent, registered with scope: ', registration.scope );
        });
        sessionStorage[ "time-offset" ] = String( "0" );
    </script>
    <script>
        function getData( url, apikey ) {
            return new Promise( function( resolve, reject ) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if ( this.readyState == 4 && this.status == 200 ) {
                        resolve( xhttp.responseText );
                    };
                }
                xhttp.open( "GET", url, true );
                if ( apikey ) {
                    xhttp.setRequestHeader( "X-Api-Key", apikey );                    
                }
                xhttp.send();
            });
        }
    </script>
    <script>
        function postJson( url, apikey, json ) {
            return new Promise( function( resolve, reject ) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if ( this.readyState == 4 && ( this.status >= 200 && this.status < 300 ) ) {
                        resolve( xhttp.responseText );
                    };
                }
                xhttp.open( "POST", url, true );
                xhttp.setRequestHeader( "Content-type", "application/json" );
                xhttp.setRequestHeader( "X-Api-Key", apikey );
                xhttp.send ( json );
            });
        }
    </script>
    <script>
        async function getBalance() {
            if ( !wallet_url || wallet_url == "" ) {
                return `${t('loading')}`;
            }
            var domain = wallet_url.substring( 0, wallet_url.indexOf( "/wallet" ) );
            var url = domain + "/api/v1/wallet";
            var winfo = await getData( url, readkey )
            winfo = JSON.parse( winfo );
            var balance = String( Math.floor( winfo[ "balance" ] / 1000 ) );
            if ( document.getElementsByClassName( "manage-wallet-outer" )[ 0 ] && document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getElementsByClassName( "message" )[ 0 ] ) {
                document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getElementsByClassName( "message" )[ 0 ].innerText = balance + " sats";
            }
            if ( document.getElementsByClassName( "message-header" )[ 0 ] && document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "message" )[ 0 ] && document.getElementsByClassName( "message-header" )[ 0 ] && document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "message" )[ 0 ].innerText == `${t('loading')}` ) {
                document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "message" )[ 0 ].innerText = String( balance ) + " sats";
            }
            if ( localStorage[ "wallet_balance" ] ) {
                var old_wallet_balance = Number( localStorage[ "wallet_balance" ] );
            } else {
                localStorage[ "wallet_balance" ] = 0;
                var old_wallet_balance = 0;
            }
            if ( !sessionStorage[ "wallet_checked" ] ) {
                sessionStorage[ "wallet_checked" ] = "checked";
                localStorage[ "wallet_balance" ] = String( balance );
            }
            if ( balance - old_wallet_balance > 0 ) {
                var balance_for_notification = balance - old_wallet_balance;
                if ( balance_for_notification > 999 ) {
                    balance_for_notification = "999+";
                }
                document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText = String( balance_for_notification );
                document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].setAttribute( "data-current-balance", String( balance ) );
                document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getElementsByClassName( "notification" )[ 0 ].style.display = "inline";
            }
        }
    </script>
    <script>
        async function setOffset() {
            var time = await getData( "https://worldtimeapi.org/api/ip" );
            var realnow = JSON.parse( time )[ "unixtime" ];
            var claimednow = Math.floor( Date.now() / 1000 );
            var offset = realnow - claimednow;
            sessionStorage[ "time-offset" ] = offset;
        }
    </script>
    <script>
        function bold( text ) {
            var bold = /\*\*(.*?)\*\*/gm;
            var html = text.replace( bold, '<strong>$1</strong>' );
            return html;
        }
        function italicize( text ) {
            var italicize = /\*(.*?)\*/gm;
            var html = text.replace( italicize, '<span style="font-style: italic;">$1</span>' );
            return html;
        }
        function triplebackticks( text ) {
            var triplebackticks = /\`\`\`([\s\S]*?)\`\`\`/g;
            var html = text.replace( triplebackticks, '<pre style="white-space: pre-wrap; padding: 5px; background-color: #999; font-size: 12px; color: white;">$1</pre>' );
            return html;
        }
        function backticks( text ) {
            var backticks = /\`(.*?)\`/gm;
            var html = text.replace( backticks, '<pre style="display: inline-block; white-space: pre-wrap; padding: 5px; background-color: #999; font-size: 12px; color: white;">$1</pre>' );
            return html;
        }
        function youtube_parser( url ) {
            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            var match = url.match( regExp );
            return ( match && match[ 7 ].length == 11 ) ? match[ 7 ] : false;
        }
        function isStringUrl( string ) {
            if ( string.indexOf( " " ) >= 0 || string.indexOf( "<" ) >= 0 || string.indexOf( ">" ) >= 0 || string.indexOf( "&gt;" ) >= 0 || string.indexOf( "&lt;" ) >= 0 || string.indexOf( "'" ) >= 0 || string.indexOf( '"' ) >= 0 ) {
                return;
            }
            try {
                var arr = string.match( /\S+\.{1}[a-zA-Z0-9\?\=\&\$\+\,\;\@\#\%\-\_]{2,}\/?[a-zA-Z0-9/\\?\=\&\$\+\,\;\@\#\%\-\_\.]*/g );
                if ( typeof( arr ) == "object" && arr.length == 1 ) {
                    return true;
                }
                return;
            } catch( e ) {
                return;
            }
        }
        function urlify( text, isMine ) {
            var ytRegex = /(http:|https:)?\/\/(www\.)?(youtube.com|youtu.be)\/(watch)?(\?v=)?(\S+)?/g
            var imgRegex = /\b(https?:\/\/\S+(?:\.png|\.jpe?g|\.gif|\.webp|\.PNG|\.JPE?G|\.GIF|\.WEBP)\S*)\b/g;
            var imgRegex2 = /\b(https?:\/\/nostr\.crustapps\.net\/ipfs\/\S+)\b/g;
            var urlRegex = /\S+\.{1}[a-zA-Z0-9\?\=\&\$\+\,\;\@\#\%\-\_]{2,}\/?[a-zA-Z0-9/\\?\=\&\$\+\,\;\@\#\%\-\_\.]*/g;
            var returnable = "";
            if ( !isMine && !text.match( ytRegex ) && !text.match( imgRegex ) && !text.match( imgRegex2 ) ) {
                returnable = text.replace( urlRegex, ( url ) => {
                    if ( url.includes( ".." ) ) {
                        return url;
                    }
                    var url2 = url;
                    if ( !url.startsWith( "http://" ) && !url.startsWith( "https://" ) ) {
                        url2 = "http://" + url;
                    }
                    return `<a onclick="event.stopPropagation()" href="${url2}" target="_blank" rel="nofollow noopener" style="color: #4287f5;">${url}</a>`;
                })                
            }
            if ( isMine && !text.match( ytRegex ) && !text.match( imgRegex ) && !text.match( imgRegex2 ) ) {
                returnable = text.replace( urlRegex, ( url ) => {
                    if ( url.includes( ".." ) ) {
                        return url;
                    }
                    var url2 = url;
                    if ( !url.startsWith( "http://" ) && !url.startsWith( "https://" ) ) {
                        url2 = "http://" + url;
                    }
                    return `<a onclick="event.stopPropagation()" href="${url2}" target="_blank" rel="nofollow noopener" style="color: white;">${url}</a>`;
                })
            }
            if ( text.match( imgRegex ) ) {
                returnable = text.replace( imgRegex, ( img ) => {
                    if ( localStorage[ "img_cache" ] ) {
                        var imgs = JSON.parse( localStorage[ "img_cache" ] );
                    } else {
                        var imgs = [];
                        localStorage[ "img_cache" ] = JSON.stringify( imgs );
                    }
                    if ( isMine && imgs.includes( img ) ) {
                        var i; for ( i=0; i<imgs.length; i++ ) {
                            if ( imgs[ i ] == img ) {
                                imgs.splice( i, 1 );
                            }
                        }
                        imgs.unshift( img );
                    }
                    if ( isMine && imgs.length >= 50 && !imgs.includes( img ) ) {
                        imgs.unshift( img );
                        imgs.pop();
                    } else if ( isMine && !imgs.includes( img ) ) {
                        imgs.unshift( img );
                    }
                    localStorage[ "img_cache" ] = JSON.stringify( imgs );
                    return `<a href="${img}" target="_blank" rel="nofollow noopener" onclick="event.stopPropagation()"><img src="${img}" onclick="event.stopPropagation()" /></a>`;
                })
            }
            if (text.match( imgRegex2 ) ) {
                returnable = text.replace( imgRegex2, ( img ) => {
                    if ( localStorage[ "img_cache" ] ) {
                        var imgs = JSON.parse( localStorage[ "img_cache" ] );
                    } else {
                        var imgs = [];
                        localStorage[ "img_cache" ] = JSON.stringify( imgs );
                    }
                    if ( isMine && imgs.includes( img ) ) {
                        var i; for ( i=0; i<imgs.length; i++ ) {
                            if ( imgs[ i ] == img ) {
                                imgs.splice( i, 1 );
                            }
                        }
                        imgs.unshift( img );
                    }
                    if ( isMine && imgs.length >= 50 && !imgs.includes( img ) ) {
                        imgs.unshift( img );
                        imgs.pop();
                    } else if ( isMine && !imgs.includes( img ) ) {
                        imgs.unshift( img );
                    }
                    localStorage[ "img_cache" ] = JSON.stringify( imgs );
                    return `<a href="${img}" target="_blank" rel="nofollow noopener" onclick="event.stopPropagation()"><img src="${img}" onclick="event.stopPropagation()" /></a>`;
                })
            }
            if ( text.match( ytRegex ) ) {
                returnable = text.replace( ytRegex, ( yt ) => {
                    if ( yt.endsWith( ")" ) ) {
                        yt = yt.substring( 0, yt.length - 1 );
                    }
                    var vid = `<div class="youtube-wrapper" onclick="event.stopPropagation()"><img class="ratio" src="./16x9-transparent.png" onclick="event.stopPropagation()" /><iframe class="youtube-video" src="${"https://www.youtube-nocookie.com/embed/" + youtube_parser( yt )}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen onclick="event.stopPropagation()"></iframe></div><span class="p-in-p" onclick='moveVid( this.previousElementSibling );event.stopPropagation()'>Picture-in-picture</span>`;
                    return vid;
                })
            }
            return returnable;
        }
        function markdownify( text, isMine ) {
            var returnable = urlify( text, isMine );
            returnable = bold( returnable );
            returnable = italicize( returnable );
            returnable = triplebackticks( returnable );
            returnable = backticks( returnable );
            return returnable;
        }
    </script>
    <script>
        function addDmsToSidebar() {
            var i; for ( i=0; i<document.getElementsByClassName( "dm-outer" ).length; i++ ) {
                document.getElementsByClassName( "dm-outer" )[ i ].remove();
                i = i - 1;
            }
            Object.keys( dms_info ).forEach( function( pubkey ) {
                if ( sessionStorage[ pubkey + "-counter" ] ) {
                    var messagecounter = Number( sessionStorage[ pubkey + "-counter" ] );
                } else {
                    var messagecounter = 0;
                }
                var name = DOMPurify.sanitize( dms_info[ pubkey ][ "name" ] );
                var picture = DOMPurify.sanitize( dms_info[ pubkey ][ "picture" ] );
                if ( namemap[ pubkey ] && namemap[ pubkey ] != "none" ) {
                    name = DOMPurify.sanitize( namemap[ pubkey ] );
                    dms_info[ pubkey ][ "name" ] = name;
                }
                if ( imagemap[ pubkey ] && imagemap[ pubkey ] != "none" ) {
                    picture = DOMPurify.sanitize( imagemap[ pubkey ] );
                    dms_info[ pubkey ][ "picture" ] = picture;
                }
                var num_of_new_messages = messagecounter;
                if ( !document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ] ) {
                    document.getElementsByClassName( "channels" )[ 0 ].firstElementChild.innerHTML += displayDMbox( pubkey, name, picture, messagecounter );
                }
            });
        }
    </script>
    <script>
        function shutKeyboard() {
            if ( Number( sessionStorage[ "keyboard_is_open" ] ) && window.innerHeight > ( Number( sessionStorage[ "full-window-height" ] ) * 0.9 ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.blur();
                sessionStorage[ "keyboard_is_open" ] = String( 0 );
                if ( sessionStorage[ "keyboard_size" ] ) {
                    var keyboard_size = Number( sessionStorage[ "keyboard_size" ] );
                    if ( document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-id" ) ) {
                        var type = "content";
                    } else {
                        var type = "message-content";
                    }
                    var current_height = document.getElementsByClassName( type )[ 0 ].scrollTop;
                    var new_height = ( current_height - keyboard_size ) - 50;
                    var max_height = document.getElementsByClassName( type )[ 0 ].scrollHeight;
                    if ( new_height > max_height - 1500 ) {new_height = max_height;}
                    document.getElementsByClassName( type )[ 0 ].scrollTo({top: new_height, left: 0, behavior: "smooth"});
                }
            }
            setTimeout( shutKeyboard, 1000 );
        }
    </script>
    <script>
        async function importWalletFromNostrOrMakeOne( alterpubkey ) {
            var importWalletSubId   = "00000003" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
            var importWalletFilter  = { "#p": [ alterpubkey ] }
            var importWalletSub     = [ "REQ", importWalletSubId, importWalletFilter ];
            socket.send( JSON.stringify( importWalletSub ) );
            setTimeout( function() {
                var closer = [ "CLOSE", importWalletSubId ];
                socket.send( JSON.stringify( closer ) );
            }, 1500 );
        }
    </script>
    <script>
        if ( window.location.href.includes( "brilliancebitcoin.github.io/nostrgram" ) && !window.location.href.includes( "brilliancebitcoin.github.io/nostrgram-test" ) ) {
            window.location.href = "https://anigma.io/";
        }
        var { getSharedSecret, schnorr, utils } = nobleSecp256k1;
        var crypto  = window.crypto;
        var getRand = size => crypto.getRandomValues( new Uint8Array( size ) );
        var sha256  = bitcoinjs.crypto.sha256;
        const urlParams = new URLSearchParams(window.location.search);
        var channelParam = urlParams.get( 'channel' );
        var profileParam = urlParams.get( 'profile' );
        if ( profileParam && profileParam.startsWith( "npub" ) && isBech32( profileParam ) ) {
            profileParam = pubkeyFromNpub( profileParam );
        }
        var relayParam = urlParams.get( 'relay' );
        if ( localStorage[ "backup" ] ) {
            var backup = JSON.parse( localStorage[ "backup" ] );
            var privKey = backup[ "privkey" ];
            var pubKey = backup[ "pubkey" ];
            var subscribed_channels = JSON.parse( backup[ "channels" ] );
            if ( channelParam && !subscribed_channels.includes(channelParam) ) {
                subscribed_channels.push( channelParam );
            }
//            var relay = relayParam || JSON.parse( backup[ "relays" ] )[ 0 ];
//            var relay = relayParam || "wss://relay.nostr.ch";
            var relay = relayParam || "wss://relay.snort.social";
        } else {
            var keypair = bitcoinjs.ECPair.makeRandom();
            var privKey = keypair.privateKey.toString( "hex" );
            var pubKey  = keypair.publicKey.toString( "hex" );
            pubKey      = pubKey.substring( 2 );
            var subscribed_channels = [ channelParam || "25e5c82273a271cb1a840d0060391a0bf4965cafeb029d5ab55350b418953fbb" ];
//            var relay = relayParam || "wss://relay.damus.io";
            var relay = relayParam || "wss://relay.nostr.ch";
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
        }
        if ( localStorage[ "namemap" ] ) {
            var namemap = JSON.parse( localStorage[ "namemap" ] );
        } else {
            var namemap = {}
        }
        if ( localStorage[ "imagemap" ] ) {
            var imagemap = JSON.parse( localStorage[ "imagemap" ] );
        } else {
            var imagemap = {}
        }
        if ( localStorage[ "dms_info" ] ) {
            var dms_info = JSON.parse( localStorage[ "dms_info" ] );
        } else {
            var dms_info = {}
        }
        if ( localStorage[ "msg_cache" ] ) {
            var msg_cache = JSON.parse( localStorage[ "msg_cache" ] );
        } else {
            var msg_cache = {}
            subscribed_channels.forEach( function( id ) {
                msg_cache[ id ] = [];
            });
            Object.keys( dms_info ).forEach( function( pubkey ) {
                msg_cache[ pubkey ] = [];
            });
            localStorage[ "msg_cache" ] = JSON.stringify( msg_cache );
        }
        if ( localStorage[ "local_pubkey_blacklist" ] ) {
            var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
        } else {
            var local_pubkey_blacklist = [];
        }
        var wallet_id = "";
        var adminkey = "";
        var readkey = "";
        var wallet_url = "";
        var lud06 = "";
        var array_of_pubkeys = [];
        var existing_messages = [];
        var array_of_replies = [];
        var socket = new WebSocket( relay );
        var heartbeat = false;
        var alterPrivKey = privKey.substring( 32 ) + privKey.substring( 0, 32 );
        var alterPubKey = nobleSecp256k1.getPublicKey( alterPrivKey, true ).substring( 2 );
        var i_should_create_a_new_wallet = true;
        sessionStorage[ "my-name" ] = pubKey.substring( 0, 15 ) + "...";
        sessionStorage[ "full-window-height" ] = window.innerHeight;
        sessionStorage[ "keyboard_is_open" ] = String( 0 );

        async function getWallet() {
            if ( localStorage[ "wallet_info" ] ) {
                var wallet_info = JSON.parse( localStorage[ "wallet_info" ] );
                wallet_id = wallet_info[ "wallet_id" ];
                adminkey = wallet_info[ "adminkey" ];
                readkey = wallet_info[ "readkey" ];
                wallet_url = wallet_info[ "wallet_url" ];
                var domain = wallet_url.substring( 0, wallet_url.indexOf( "/wallet" ) );
                var url = domain + "/lnurlp/api/v1/links";
                var lnurls = await getData( url, readkey )
                lnurls = JSON.parse( lnurls );
                lnurls.sort( function( a, b ) {
                    return b.id - a.id;
                });
                if ( lnurls[ 0 ] && lnurls[ 0 ][ "lnurl" ] ) {
                    var prevlud06 = lud06;
                    lud06 = lnurls[ 0 ][ "lnurl" ];
                }
                if ( prevlud06 != lud06 ) {
                    submitUserInfo();
                }
            } else {
                importWalletFromNostrOrMakeOne( alterPubKey );
            }
        }

        async function handleMessage( message ) {
            heartbeat = true;
            var [ type, subId, event ] = JSON.parse( message.data );
            var { kind, content } = event || {}
            if ( content && content.length > 3000 ) return;
            if ( kind && subId.startsWith( "00000000" ) ) {
                if ( kind != 40 ) {
                    showToast( `${t('unknownError')}` );
                }
                var isError = checkForChannelSubscriptionErrors( content );
                if ( isError ) {
                    showToast( `${t('unknownError')}` );
                } else {
                    const idPurified = DOMPurify.sanitize( event.id, { USE_PROFILES: { html: false, xml: false, svgFilters: false, mathMl: false } });
                    const picPurified = DOMPurify.sanitize( JSON.parse( content )[ "picture" ], { USE_PROFILES: { html: false, xml: false, svgFilters: false, mathMl: false } } );
                    const namePurified = DOMPurify.sanitize( JSON.parse( content )[ "name" ], { USE_PROFILES: { html: false, xml: false, svgFilters: false, mathMl: false } } );
                    var picture =
                    document.getElementsByClassName( "removable-channels" )[ 0 ].innerHTML += `
                            <div class="removable-channel ${event.id}">
                                <span class="x-circle" onclick="removeChannel( '${idPurified}' )">&times;</span>
                                <span class="img-circle" style="background-image: url('${picPurified}')"></span>
                                <span class="removable-channel-name">${namePurified}</span>
                                <div style="clear: both"></div>
                            </div>
                    `;
                }
            }
            if ( subId.startsWith( "00000001" ) ) {
                if ( content && !checkForUserMetaErrors( content ) ) {
                    //path if I am updating my own info
                    if ( event.pubkey == pubKey ) {
                        var myMetaInfo = {}
                        if ( "name" in JSON.parse( content ) ) {
                            if ( document.getElementsByClassName( "display-name" )[ 0 ] ) {
                                document.getElementsByClassName( "display-name" )[ 0 ].value = JSON.parse( content )[ "name" ];
                            }
                            if ( document.getElementsByClassName( "user-profile-inner" )[ 0 ] && document.getElementsByClassName( "user-profile-inner" )[ 0 ].getElementsByClassName( "name" )[ 0 ] && JSON.parse( content )[ "name" ] && JSON.parse( content )[ "name" ] != "" ) {
                                document.getElementsByClassName( "user-profile-inner" )[ 0 ].getElementsByClassName( "name" )[ 0 ].innerHTML = JSON.parse( content )[ "name" ];
                            }
                            if ( document.getElementsByClassName( "profile-name" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && pubkeyFromNpub( document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText ) == event.pubkey ) {
                                document.getElementsByClassName( "profile-name" )[ 0 ].innerText = JSON.parse( content )[ "name" ];
                            }
                            if ( document.getElementsByClassName( "profile-pubkey-title" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && pubkeyFromNpub( document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText ) == event.pubkey ) {
                                document.getElementsByClassName( "profile-pubkey-title" )[ 0 ].innerText = JSON.parse( content )[ "name" ] + "'s public key";
                            }
                            sessionStorage[ "my-name" ] = JSON.parse( content )[ "name" ];
                        }
                        if ( "about" in JSON.parse( content ) ) {
                            if ( document.getElementsByClassName( "about-input" )[ 0 ] ) {
                                document.getElementsByClassName( "about-input" )[ 0 ].value = JSON.parse( content )[ "about" ];
                            }
                        }
                        if ( "picture" in JSON.parse( content ) ) {
                            if ( document.getElementsByClassName( "user-picture" )[ 0 ] ) {
                                document.getElementsByClassName( "user-picture" )[ 0 ].value = JSON.parse( content )[ "picture" ];
                            }
                            if ( document.getElementsByClassName( "big-picture" )[ 0 ] && JSON.parse( content )[ "picture" ] && JSON.parse( content )[ "picture" ] != "" ) {
                                document.getElementsByClassName( "big-picture" )[ 0 ].src = JSON.parse( content )[ "picture" ];
                            }
                            if ( document.getElementsByClassName( "user-in-sidebar" )[ 0 ] && document.getElementsByClassName( "user-in-sidebar" )[ 0 ].getElementsByTagName( "span" )[ 0 ] && JSON.parse( content )[ "picture" ] && JSON.parse( content )[ "picture" ] != "" ) {
                                document.getElementsByClassName( "user-in-sidebar" )[ 0 ].getElementsByTagName( "span" )[ 0 ].style = "background-image: url('" + JSON.parse( content )[ "picture" ] + "')";
                            }
                        }
                        Object.keys( JSON.parse( content ) ).forEach( function( key ) {
                            myMetaInfo[ key ] = JSON.parse( content )[ key ];
                        })
                        localStorage[ "my-meta-info" ] = JSON.stringify( myMetaInfo );
                    }
                    //path if I am updating someone else's info
                    if ( "name" in JSON.parse( content ) && !( !JSON.parse( content )[ "name" ] || JSON.parse( content )[ "name" ] == "" ) ) {
                        //stop if the metadata you are getting belongs to a different user
                        if ( document.querySelector( ".profile-pubkey" ) && event.pubkey != pubkeyFromNpub( document.querySelector( ".profile-pubkey" ).innerText ) ) return;
                        namemap[ event.pubkey ] = DOMPurify.sanitize( JSON.parse( content )[ "name" ] );
                        localStorage[ "namemap" ] = JSON.stringify( namemap );
                        var i; for ( i=0; i<document.getElementsByClassName( event.pubkey ).length; i++ ) {
                            document.getElementsByClassName( event.pubkey )[ i ].innerText = DOMPurify.sanitize( JSON.parse( content )[ "name" ] );
                        }
                        if ( document.getElementsByClassName( "profile-name" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && pubkeyFromNpub( document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText ) == event.pubkey ) {
                            document.getElementsByClassName( "profile-name" )[ 0 ].innerText = DOMPurify.sanitize( JSON.parse( content )[ "name" ] );
                        }
                        if ( document.getElementsByClassName( "profile-pubkey-title" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && pubkeyFromNpub( document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText ) == event.pubkey ) {
                            document.getElementsByClassName( "profile-pubkey-title" )[ 0 ].innerText = DOMPurify.sanitize( JSON.parse( content )[ "name" ] ) + "'s public key";
                        }
                    } else {
                        namemap[ event.pubkey ] = "none";
                        localStorage[ "namemap" ] = JSON.stringify( namemap );
                    }
                    if ( "about" in JSON.parse( content ) && !( !JSON.parse( content )[ "about" ] || JSON.parse( content )[ "about" ] == "" ) ) {
                        //stop if the metadata you are getting belongs to a different user
                        if ( document.querySelector( ".profile-pubkey" ) && event.pubkey != pubkeyFromNpub( document.querySelector( ".profile-pubkey" ).innerText ) ) return;
                        if ( document.getElementsByClassName( "profile-about" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && pubkeyFromNpub( document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText ) == event.pubkey ) {
                            document.getElementsByClassName( "profile-about" )[ 0 ].innerHTML = markdownify( DOMPurify.sanitize( JSON.parse( content )[ "about" ] ) );
                            document.getElementsByClassName( "profile-about" )[ 0 ].style.display = "block";
                        }
                    }
                    if ( "lud06" in JSON.parse( content ) && !( !JSON.parse( content )[ "lud06" ] || JSON.parse( content )[ "lud06" ] == "" ) ) {
                        //stop if the metadata you are getting belongs to a different user
                        if ( document.querySelector( ".profile-pubkey" ) && event.pubkey != pubkeyFromNpub( document.querySelector( ".profile-pubkey" ).innerText ) ) return;
                        if ( document.getElementsByClassName( "profile-lud06" )[ 0 ] && !document.getElementsByClassName( "tipper" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && pubkeyFromNpub( document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText ) == event.pubkey ) {
                            var button = document.createElement( "button" );
                            button.className = "tipper";
                            button.innerText = "Tip this user";
                            button.onclick = function() {
                                var a = document.createElement( "a" );
                                a.href = "lightning:" + JSON.parse( content )[ "lud06" ].toLowerCase();
                                a.target = "_blank";
                                a.append( createQR( DOMPurify.sanitize( JSON.parse( content )[ "lud06" ] ) ) );
                                document.getElementById( "modal" ).innerHTML = "";
                                document.getElementById( "modal" ).append( a );
                                document.getElementById( "modal" ).innerHTML += '<div align="center" style="font-weight: bold;">click or scan</div>';
                                document.getElementById( "black-bg" ).style.display = "block";
                                document.getElementById( "modal" ).style.display = "block";
                            }
                            document.getElementsByClassName( "profile-lud06" )[ 0 ].append( button );
                            document.getElementsByClassName( "profile-lud06" )[ 0 ].style.display = "block";
                        }
                    }
                    if ( "picture" in JSON.parse( content ) && !( !JSON.parse( content )[ "picture" ] || JSON.parse( content )[ "picture" ] == "" ) ) {
                        //stop if the metadata you are getting belongs to a different user
                        if ( document.querySelector( ".profile-pubkey" ) && event.pubkey != pubkeyFromNpub( document.querySelector( ".profile-pubkey" ).innerText ) ) return;
                        picture = JSON.parse( content )[ "picture" ];
                        if ( !isStringUrl( picture ) ) {
                            picture = `https://www.gravatar.com/avatar/${event.pubkey}?s=128&d=retro`;
                        }
                        imagemap[ event.pubkey ] = DOMPurify.sanitize( picture );
                        localStorage[ "imagemap" ] = JSON.stringify( imagemap );
                        var i; for ( i=0; i<document.getElementsByClassName( event.pubkey ).length; i++ ) {
                            if ( document.getElementsByClassName( event.pubkey )[ i ] && document.getElementsByClassName( event.pubkey )[ i ].parentElement && document.getElementsByClassName( event.pubkey )[ i ].parentElement.parentElement && document.getElementsByClassName( event.pubkey )[ i ].parentElement.parentElement.getElementsByClassName( "picture" )[ 0 ] ) {
                                document.getElementsByClassName( event.pubkey )[ i ].parentElement.parentElement.getElementsByClassName( "picture" )[ 0 ].style.backgroundImage = "url(" + DOMPurify.sanitize( picture ) + ")";
                            }
                        }
                        if ( document.getElementsByClassName( "big-picture" )[ 0 ] && document.getElementsByClassName( "channel-wrapper" )[ 0 ].getElementsByClassName( "name" )[ 0 ].innerText != `${t('settings')}` && document.getElementsByClassName( "profile-pubkey" )[ 0 ] && document.getElementsByClassName( "profile-pubkey" )[ 0 ].innerText == event.pubkey ) {
                            document.getElementsByClassName( "big-picture" )[ 0 ].src = DOMPurify.sanitize( JSON.parse( content )[ "picture" ] );
                        }
                    } else {
                        imagemap[ event.pubkey ] = "none";
                        localStorage[ "imagemap" ] = JSON.stringify( imagemap );
                    }
                } else if ( content && checkForUserMetaErrors( content ) ) {
                    namemap[ event.pubkey ] = "none";
                    localStorage[ "namemap" ] = JSON.stringify( namemap );
                    imagemap[ event.pubkey ] = "none";
                    localStorage[ "imagemap" ] = JSON.stringify( imagemap );
                }
                var closer = [ "CLOSE", subId ];
                socket.send(JSON.stringify( closer ));
            }
            //this 03 code runs when the user's client checks if wallet data is stored on nostr
            //this happens only when it can't find wallet data in local storage
            //wallet data should be in a certain format and the function should check if the
            //sender is himself and that the sig is valid, otherwise malicious people might
            //send fake wallet data and thus replace the user's real wallet with the hacker's.
            //If and only if there is no wallet data stored on nostr, it should create a wallet
            if ( subId.startsWith( "00000003" ) ) {
                if ( JSON.parse( message[ "data" ] )[ 0 ] == "EOSE" && ( !localStorage[ "wallet_info" ] || localStorage[ "wallet_info" ] == "" ) ) {
                    if ( !i_should_create_a_new_wallet ) return;
                    var mywallet = await getData( "https://legend.lnbits.com/wallet?nme=" + pubkeyToNpub( pubKey ).substring( 0, 15 ) );
                    var key1prep = mywallet.split( "Wallet ID:" );
                    wallet_id = key1prep[ 1 ].substring( 14, 46 );
                    var key2prep = mywallet.split( "Admin key:" );
                    adminkey = key2prep[ 1 ].substring( 14, 46 );
                    var key3prep = mywallet.split( "Invoice/read key:" );
                    readkey = key3prep[ 1 ].substring( 14, 46 );
                    var key4prep = mywallet.split( "<qrcode" );
                    wallet_url = key4prep[ 2 ].split( "'" )[ 1 ] + key4prep[ 2 ].split( "'" )[ 3 ];
                    wallet_obj = {}
                    wallet_obj[ "wallet_id" ] = wallet_id;
                    wallet_obj[ "adminkey" ] = adminkey;
                    wallet_obj[ "readkey" ] = readkey;
                    wallet_obj[ "wallet_url" ] = wallet_url;
                    localStorage[ "wallet_info" ] = JSON.stringify( wallet_obj );
                    sendEncryptedNote( JSON.stringify( wallet_obj ), alterPubKey );
                    var json = {}
                    json[ "description" ] = pubKey;
                    json[ "min" ] = 1;
                    json[ "max" ] = 9007199254740991;
                    json[ "comment_chars" ] = 240;
                    var domain = wallet_url.substring( 0, wallet_url.indexOf( "/wallet" ) );
                    var response = await postJson( domain + "/lnurlp/api/v1/links", adminkey, JSON.stringify( json ) );
                    var response = JSON.parse( response );
                    lud06 = response[ "lnurl" ];
                    submitUserInfo();
                } else if ( JSON.parse( message[ "data" ] )[ 0 ] != "EOSE" ) {
                    i_should_create_a_new_wallet = false;
                    var thisevent = JSON.parse( message[ "data" ] )[ 2 ];
                    if ( thisevent[ "pubkey" ] != pubKey ) {
                        i_should_create_a_new_wallet = true;
                        return;
                    }
                    var sig_is_valid = await nobleSecp256k1.schnorr.verify( thisevent[ "sig" ], thisevent[ "id" ], thisevent[ "pubkey" ] );
                    if ( !sig_is_valid ) {
                        var alert = `${t('importWalletError')} (id: ${thisevent[ "id" ]}). ${t('relayPart')}`;
                        alert( alert );
                        return;
                    }
                    var wallet = JSON.parse( decrypt( privKey, alterPubKey, thisevent[ "content" ] ) );
                    var walletIsValid = checkForWalletImportErrors( wallet );
                    if ( !walletIsValid ) {
                        showToast( `${t('importWalletError')}`);
                        return;
                    }
                    wallet_id = wallet[ "wallet_id" ];
                    adminkey = wallet[ "adminkey" ];
                    readkey = wallet[ "readkey" ];
                    wallet_url = wallet[ "wallet_url" ];
                    localStorage[ "wallet_info" ] = JSON.stringify( wallet );
                    var domain = wallet_url.substring( 0, wallet_url.indexOf( "/wallet" ) );
                    var url = domain + "/lnurlp/api/v1/links";
                    var lnurls = await getData( url, readkey )
                    lnurls = JSON.parse( lnurls );
                    lnurls.sort( function( a, b ) {
                        return b.id - a.id;
                    });
                    if ( lnurls[ 0 ] && lnurls[ 0 ][ "lnurl" ] ) {
                        lud06 = lnurls[ 0 ][ "lnurl" ];
                    }
                    submitUserInfo();
                }
            }
            if ( kind == 40 ) {
                if ( JSON.parse( message[ "data" ] )[ 0 ] == "EOSE" ) return;
                if ( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( event.id )[ 0 ] ) return
                var isError = checkForChannelSubscriptionErrors( content );
                if ( isError ) {
                    showToast( `${t('unknownError')}` );
                } else {
                    document.getElementsByClassName( "channels" )[ 0 ].firstElementChild.innerHTML += displayChannel( DOMPurify.sanitize( JSON.parse( content )[ "picture" ] ), DOMPurify.sanitize( JSON.parse( content )[ "name" ] ), "", event.id, event.created_at );
                    getLatestMessage( event.id );
                    addDmsToSidebar();
                    var channel = document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( event.id )[ 0 ];
                    if ( subId.startsWith( "00000000" ) ) {
                        selectChannel( channel );
                    }
                }
                var closer = [ "CLOSE", subId ];
                socket.send(JSON.stringify( closer ));
            }
            if ( kind == 42 && subId.includes( "latest-message" ) ) {
                if ( JSON.parse( message[ "data" ] )[ 0 ] == "EOSE" ) return;
                if ( localStorage[ "local_pubkey_blacklist" ] ) {
                    var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
                } else {
                    var local_pubkey_blacklist = [];
                }
                if ( local_pubkey_blacklist.includes( event.pubkey ) ) return;
                var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
                var event_time = event.created_at;
                var how_long_ago = convertHMS( now - event_time );
                if ( now - event_time < -600 ) return;
                var isMine = ( event.pubkey == pubKey );
                if ( !isMine && !array_of_pubkeys.includes( event.pubkey ) ) {
                    array_of_pubkeys.push( event.pubkey );
                }
                var events_replied_to = [];
                var pubkeys_replied_to = [];
                var i; for ( i=0; i<event.tags.length; i++ ) {
                    if ( event[ "tags" ][ i ][ 0 ] == "e" ) {
                        events_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                    if ( event[ "tags" ][ i ][ 0 ] == "p" ) {
                        pubkeys_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                }
                var parent = events_replied_to[ 0 ];
                var replyingTo = "";
                if ( events_replied_to[ 1 ] ) {
                    replyingTo = events_replied_to[ 1 ];
                    array_of_replies.push( [ event.id, replyingTo ] );
                }
                content = content.replace( /&/g, "&#38;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" );
                content = DOMPurify.sanitize( content );
                var shortened_content = content.replace( /\n/g, " " ).substring( 0, 50 );
                if ( content.length > 50 ) {
                    shortened_content = shortened_content + "...";
                }
                content = markdownify( content, isMine );
                array_of_replies.forEach( function( item ) {
                    if ( item[ 1 ] == event.id ) {
                        var replyPubkey = event.pubkey;
                        if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                            var person_name = namemap[ event.pubkey ];
                        } else {
                            var person_name = replyPubkey.substring( 0, 15 );
                        }
                        if ( replyPubkey != pubKey ) {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + person_name + `</span>`;
                        } else {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + sessionStorage[ "my-name" ] + `</span>`;
                        }
                        replyContent = shortened_content;
                        if ( document.getElementsByClassName( item[ 0 ] )[ 0 ] ) {
                            document.getElementsByClassName( item[ 0 ] )[ 0 ].getElementsByClassName( "reply-prefix" )[ 0 ].innerHTML = replyAuthor + '<br>' + replyContent;
                        }
                    }
                });
                var color = "";
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "e" || event.pubkey.substring( 0, 1 ) == "f" ) ) {
                    color = "red";
                }
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "c" || event.pubkey.substring( 0, 1 ) == "d" ) ) {
                    color = "pink";
                };
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "a" || event.pubkey.substring( 0, 1 ) == "b" ) ) {
                    color = "orange";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 10 ) {
                    color = "yellow";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 8 ) {
                    color = "green";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 6 ) {
                    color = "lightblue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 4 ) {
                    color = "blue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 2 ) {
                    color = "purple";
                };
                var name = pubkeyToNpub( event.pubkey ).substring( 0, 15 ) + "...";
                //var picture = "https://hashvatar.vercel.app/" + event.pubkey;
                var picture = "https://www.gravatar.com/avatar/" + event.pubkey + "?s=128&d=retro";
                if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                    name = namemap[ event.pubkey ];
                }
                name = DOMPurify.sanitize( name );
                if ( event.pubkey in imagemap && imagemap[ event.pubkey ] != "none" ) {
                    picture = imagemap[ event.pubkey ];
                }
                if ( !msg_cache[ parent ] ) {
                    msg_cache[ parent ] = [];
                }
                if ( Number( document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].innerText = shortened_content;
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago )
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time )
                }
                //If the current message is not already in the message cache, add it, and also add to the number of unread messages
                var messageIsKnown = false;
                msg_cache[ parent ].forEach( function( message, index ) {
                    if ( Object.keys( message )[ 0 ] == event.id ) {
                        messageIsKnown = true;
                    }
                });
                if ( !messageIsKnown ) {
                    addMessageToCache( event.pubkey, event.id, event_time, parent, color, name, picture, content, replyingTo );
                    if ( !document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].classList.contains( "active" ) ) {
                        var old_num_of_new_messages = Number( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getAttribute( "data-num-of-new-messages" ) );
                        new_num_of_new_messages = old_num_of_new_messages + 1;
                        document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].setAttribute( "data-num-of-new-messages", String( new_num_of_new_messages ) );
                        if ( new_num_of_new_messages > 0 ) {
                            document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText = String( new_num_of_new_messages );
                            if ( new_num_of_new_messages > 199 ) {
                                document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText += "+";
                            }
                            document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getElementsByClassName( "notification" )[ 0 ].style.display = "inline";
                        }
                    }
                }
                //if you are currently looking at the channel, add the message to the channel
                if ( !document.getElementsByClassName( parent )[ 0 ].classList.contains( "active" ) ) return;
                if ( document.getElementsByClassName( event.id )[ 0 ] ) return;
                var div = document.createElement( "div" );
                div.classList.add( "message" );
                div.classList.add( event.id );
                div.setAttribute( "data-author", event.pubkey );
                var what_for_reply = ( replyingTo ) ? replyingTo:event.pubkey;
                div.onclick = function() {msgContext( event.id, event.pubkey, what_for_reply, content );}
                if ( isMine ) {
                    div.align = "right";
                }
                if ( isMine ) {
                    var replyclass = "reply-in-blue";
                } else {
                    var replyclass = "reply-in-white";
                }
                var replyAuthor = `<span class="reply-author">${t('unknown')}</span>`;
                var replyPubkey = null;
                if ( document.getElementsByClassName( replyingTo )[ 0 ] ) {
                    replyPubkey = document.getElementsByClassName( replyingTo )[ 0 ].getAttribute( "data-author" );
                }
                if ( replyPubkey == pubKey ) {
                    replyAuthor = `<span class="reply-author">${sessionStorage[ "my-name" ]}</span>`;
                }
                var replyContent = `${t('replyToMessageNotFound')}`;
                var replyPrefix = "";
                if ( replyingTo && replyingTo != "" ) {
                    if ( document.getElementsByClassName( replyingTo )[ 0 ] && document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ] && document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "msgtext" )[ 0 ] ) {
                        if ( replyPubkey != pubKey ) {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "author" )[ 0 ].innerHTML + `</span>`;
                        }
                        replyContent = document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "msgtext" )[ 0 ].innerText;
                        shortened_reply_content = replyContent.replace( /\n/g, " " ).substring( 0, 50 );
                        if ( replyContent.length > 50 ) {
                            shortened_reply_content = shortened_reply_content + "...";
                        }
                        replyContent = shortened_reply_content;
                    }
                    div.setAttribute( "data-replying-to", replyingTo );
                    replyPrefix = `<div class="reply-prefix ${replyclass}" onclick='document.getElementsByClassName( "${replyingTo}" )[ 0 ].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "0px 0px 25px 2px yellow";setTimeout( function() {document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "";}, 600 );event.stopPropagation();'>${replyAuthor}<br>${replyContent}</div>`
                }
                if ( isMine ) {
                    div.classList.add( "me" );
                    var html = `<div class="bubble" align="left">${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>`;
                    div.innerHTML = html;
                } else {
                    var html = `
                        <span class="picture" style="background-image: url('${picture}')" onclick="event.stopPropagation();showProfile( '${event.pubkey}', '${name}', '${picture}' )"></span>
                        <div class="bubble"><div class="author ${color} ${event.pubkey}">${name}</div>${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>
                    `;
                    div.innerHTML = html;
                }
                document.getElementsByClassName( "message-content" )[ 0 ].append( div );
                var last_200_messages = [];
                var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                    last_200_messages.push( document.getElementsByClassName( "bubble" )[ i ].parentElement );
                }
                last_200_messages.sort(function( a, b ) {return b.getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) - a.getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" )});
                var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                    document.getElementsByClassName( "bubble" )[ i ].parentElement.remove();
                    i = i - 1;
                }
                last_200_messages.reverse();
                last_200_messages.forEach( function( item ) {
                    document.getElementsByClassName( "message-content" )[ 0 ].append( item );
                    document.querySelectorAll( "a" ).forEach( function( a ) {if ( a.rel ) {a.target="_blank"}});
                });
                //scroll to bottom if near bottom, otherwise don't
                if ( window.innerWidth < 601 ) {
                    var scrollto = document.getElementsByClassName( "content" )[ 0 ].scrollTop;
                    var offset = 0;
                    if ( document.getElementsByClassName( "message-content" )[ 0 ] && document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" )[ 0 ] ) {
                        offset = document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" )[ document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" ).length - 1 ].offsetHeight;
                    }
                    if ( offset > 20 ) {
                        offset = offset - 20;
                    }
                    if ( ( document.getElementsByClassName( "content" )[ 0 ].scrollHeight - document.getElementsByClassName( "content" )[ 0 ].scrollTop ) > 1500 ) {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTo( 0, scrollto + offset );
                    } else {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                        if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                            document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                        }
                    }
                } else {
                    if ( ( document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight - document.getElementsByClassName( "message-content" )[ 0 ].scrollTop ) > 1500 ) {
                        return
                    } else {
                        document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                        if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                            document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                        }
                    }
                }
            }
            //this code runs whenever a dm is clicked, it should also work for "closed dms" where you only see someone's dms if you first add them to your sidebar
            if ( kind === 4 && subId.includes( "encrypted-dms" ) ) {
                if ( JSON.parse( message[ "data" ] )[ 0 ] == "EOSE" ) return;
                if ( document.getElementsByClassName( event.id )[ 0 ] ) return;
                if ( localStorage[ "local_pubkey_blacklist" ] ) {
                    var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
                } else {
                    var local_pubkey_blacklist = [];
                }
                if ( local_pubkey_blacklist.includes( event.pubkey ) ) return;
                var isMine = ( event.pubkey == pubKey );
                if ( !isMine && !array_of_pubkeys.includes( event.pubkey ) ) {
                    array_of_pubkeys.push( event.pubkey );
                }
                var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
                var event_time = event.created_at;
                var how_long_ago = convertHMS( now - event_time );
                if ( now - event_time < -600 ) return;
                if ( event.pubkey == pubKey ) {
                    var otherKey = "";
                    var i; for ( i=0; i<event.tags.length; i++ ) {
                        if ( event[ "tags" ][ i ][ 0 ] == "p" && ( !otherKey || otherKey == "" ) ) {
                            otherKey = event[ "tags" ][ i ][ 1 ];
                            break;
                        } else {
                            otherKey = event.pubkey;
                        }
                    }
                } else {
                    otherKey = event.pubkey;
                }
                if ( !admin && window.nostr ) {
                    content = await window.nostr.nip04.decrypt( otherKey, content );
                } else {
                    content = await decrypt(privKey, otherKey, content)
                }
                if ( !document.getElementsByClassName( otherKey.substring( 0, 20 ) )[ 0 ].classList.contains( "active" ) ) return
                var color = "";
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "e" || event.pubkey.substring( 0, 1 ) == "f" ) ) {
                    color = "red";
                }
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "c" || event.pubkey.substring( 0, 1 ) == "d" ) ) {
                    color = "pink";
                };
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "a" || event.pubkey.substring( 0, 1 ) == "b" ) ) {
                    color = "orange";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 10 ) {
                    color = "yellow";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 8 ) {
                    color = "green";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 6 ) {
                    color = "lightblue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 4 ) {
                    color = "blue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 2 ) {
                    color = "purple";
                };
                var name = pubkeyToNpub( event.pubkey ).substring( 0, 15 ) + "...";
                //var picture = "https://hashvatar.vercel.app/" + event.pubkey;
                var picture = "https://www.gravatar.com/avatar/" + event.pubkey + "?s=128&d=retro";
                if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                    name = namemap[ event.pubkey ];
                }
                name = DOMPurify.sanitize( name );
                if ( event.pubkey in imagemap && imagemap[ event.pubkey ] != "none" ) {
                    picture = imagemap[ event.pubkey ];
                }
                content = content.replace( /&/g, "&#38;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" );
                var shortened_content = content.replace( /\n/g, " " ).substring( 0, 50 );
                shortened_content = DOMPurify.sanitize( shortened_content );
                if ( content.length > 50 ) {
                    shortened_content = shortened_content + "...";
                }
                content = markdownify( content, isMine );
                content = DOMPurify.sanitize( content );
                var events_replied_to = [];
                var pubkeys_replied_to = [];
                var i; for ( i=0; i<event.tags.length; i++ ) {
                    if ( event[ "tags" ][ i ][ 0 ] == "e" ) {
                        events_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                    if ( event[ "tags" ][ i ][ 0 ] == "p" ) {
                        pubkeys_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                }
                var replyingTo = "";
                if ( events_replied_to[ 0 ] ) {
                    replyingTo = events_replied_to[ 0 ];
                    array_of_replies.push( [ event.id, replyingTo ] );
                }
                array_of_replies.forEach( function( item ) {
                    if ( item[ 1 ] == event.id ) {
                        var replyPubkey = event.pubkey;
                        if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                            var person_name = namemap[ event.pubkey ];
                        } else {
                            var person_name = replyPubkey.substring( 0, 15 );
                        }
                        if ( replyPubkey != pubKey ) {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + person_name + `</span>`;
                        } else {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + sessionStorage[ "my-name" ] + `</span>`;
                        }
                        replyContent = shortened_content;
                        if ( document.getElementsByClassName( item[ 0 ] )[ 0 ] ) {
                            document.getElementsByClassName( item[ 0 ] )[ 0 ].getElementsByClassName( "reply-prefix" )[ 0 ].innerHTML = replyAuthor + '<br>' + replyContent;
                        }
                    }
                });
                var div = document.createElement( "div" );
                div.classList.add( "message" );
                div.classList.add( event.id );
                var parent = otherKey;
                if ( !msg_cache[ parent ] ) {
                    msg_cache[ parent ] = [];
                }
                msg_cache[ parent ].forEach( function( message ) {
                    existing_messages.push( Object.keys( message ) [ 0 ] )
                });
                addMessageToCache( event.pubkey, event.id, event_time, parent, color, name, picture, content, replyingTo );
                div.setAttribute( "data-author", event.pubkey );
                if ( isMine ) {
                    div.align = "right";
                }
                var what_for_reply = ( replyingTo ) ? replyingTo:event.pubkey;
                div.onclick = function() {msgContext( event.id, event.pubkey, what_for_reply, content );}
                if ( isMine ) {
                    var replyclass = "reply-in-blue";
                } else {
                    var replyclass = "reply-in-white";
                }
                var replyAuthor = `<span class="reply-author">${t('unknown')}</span>`;
                var replyPubkey = null;
                if ( document.getElementsByClassName( replyingTo )[ 0 ] ) {
                    replyPubkey = document.getElementsByClassName( replyingTo )[ 0 ].getAttribute( "data-author" );
                }
                if ( replyPubkey == pubKey ) {
                    replyAuthor = `<span class="reply-author">${sessionStorage[ "my-name" ]}</span>`;
                }
                var replyContent = "This post is a reply to a message that could not be found";
                var replyPrefix = "";
                if ( replyingTo && replyingTo != "" ) {
                    if ( document.getElementsByClassName( replyingTo )[ 0 ] && document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ] && document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "msgtext" )[ 0 ] ) {
                        replyPubkey = document.getElementsByClassName( replyingTo )[ 0 ].getAttribute( "data-author" );
                        if ( replyPubkey != pubKey ) {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "author" )[ 0 ].innerHTML + `</span>`;
                        }
                        replyContent = document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "msgtext" )[ 0 ].innerText;
                        shortened_reply_content = replyContent.replace( /\n/g, " " ).substring( 0, 50 );
                        if ( replyContent.length > 50 ) {
                            shortened_reply_content = shortened_reply_content + "...";
                        }
                        replyContent = shortened_reply_content;
                    }
                    div.setAttribute( "data-replying-to", replyingTo );
                    replyPrefix = `<div class="reply-prefix ${replyclass}" onclick='document.getElementsByClassName( "${replyingTo}" )[ 0 ].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "0px 0px 25px 2px yellow";setTimeout( function() {document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "";}, 600 );event.stopPropagation();'>${replyAuthor}<br>${replyContent}</div>`
                }
                if ( isMine ) {
                    div.classList.add( "me" );
                    var html = `<div class="bubble" align="left">${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>`;
                    div.innerHTML = html;
                } else {
                    var html = `
                        <span class="picture" style="background-image: url('${picture}')" onclick="event.stopPropagation();showProfile( '${event.pubkey}', '${name}', '${picture}' )"></span>
                        <div class="bubble"><div class="author ${color} ${event.pubkey}">${name}</div>${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>
                    `;
                    div.innerHTML = html;
                }
                if ( now - event_time > 15 ) {
                    if ( existing_messages.includes( event.id ) ) {
                        document.getElementsByClassName( "message-content" )[ 0 ].prepend( div );
                    } else {
                        document.getElementsByClassName( "message-content" )[ 0 ].append( div );
                        var last_200_messages = [];
                        var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                            last_200_messages.push( document.getElementsByClassName( "bubble" )[ i ].parentElement );
                        }
                        last_200_messages.sort(function( a, b ) {return b.getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) - a.getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" )});
                        var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                            document.getElementsByClassName( "bubble" )[ i ].parentElement.remove();
                            i = i - 1;
                        }
                        last_200_messages.reverse();
                        last_200_messages.forEach( function( item ) {
                            document.getElementsByClassName( "message-content" )[ 0 ].append( item );
                            document.querySelectorAll( "a" ).forEach( function( a ) {if ( a.rel ) {a.target="_blank"}});
                        });
                    }
                } else {
                    document.getElementsByClassName( "message-content" )[ 0 ].append( div );
                    document.querySelectorAll( "a" ).forEach( function( a ) {if ( a.rel ) {a.target="_blank"}});
                }
                var seen_messages = [];
                var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                    if ( !seen_messages.includes( document.getElementsByClassName( "bubble" )[ i ].parentElement.classList[ 1 ] ) ) {
                        seen_messages.push( document.getElementsByClassName( "bubble" )[ i ].parentElement.classList[ 1 ] )
                    } else {
                        document.getElementsByClassName( "bubble" )[ i ].parentElement.remove(); i = i - 1;
                    } 
                }
                if ( document.getElementsByClassName( "message-header" )[ 0 ] && Number( document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                }
                if ( window.innerWidth < 601 && Number( document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                }
                if ( Number( document.getElementsByClassName( otherKey.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( otherKey.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( otherKey.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago );
                }
                if ( window.innerWidth < 601 ) {
                    var scrollto = document.getElementsByClassName( "content" )[ 0 ].scrollTop;
                    var offset = 0;
                    if ( document.getElementsByClassName( "message-content" )[ 0 ] && document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" )[ 0 ] ) {
                        offset = document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" )[ document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" ).length - 1 ].offsetHeight;
                    }
                    if ( offset > 20 ) {
                        offset = offset - 20;
                    }
                    if ( ( document.getElementsByClassName( "content" )[ 0 ].scrollHeight - document.getElementsByClassName( "content" )[ 0 ].scrollTop ) > 1500 ) {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTo( 0, scrollto + offset );
                    } else {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                        if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                            document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                        }
                    }
                } else {
                    if ( ( document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight - document.getElementsByClassName( "message-content" )[ 0 ].scrollTop ) > 1500 ) {
                        return;
                    } else {
                        document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                        if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                            document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                        }
                    }
                }
            }
            if ( kind === 4 && subId.includes( "encrypted-open-dms" ) ) {
                if ( JSON.parse( message[ "data" ] )[ 0 ] == "EOSE" ) return;
                if ( localStorage[ "local_pubkey_blacklist" ] ) {
                    var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
                } else {
                    var local_pubkey_blacklist = [];
                }
                if ( local_pubkey_blacklist.includes( event.pubkey ) ) return;
                var thereAreEncryptionErrors = await checkForEncryptionErrors( privKey, event.pubkey, event[ "content" ] );
                if ( !document.getElementsByClassName( event.pubkey.substring( 0, 20 ) )[ 0 ] && !thereAreEncryptionErrors ) {
                    addPubkeyToSidebar( event.pubkey );
                }
                if ( event.pubkey == pubKey ) {
                    var otherKey = "";
                    var i; for ( i=0; i<event.tags.length; i++ ) {
                        if ( event[ "tags" ][ i ][ 0 ] == "p" && ( !otherKey || otherKey == "" ) ) {
                            otherKey = event[ "tags" ][ i ][ 1 ];
                            break;
                        } else {
                            otherKey = event.pubkey;
                        }
                    }
                } else {
                    otherKey = event.pubkey;
                }
                var parent = otherKey;
                var events_replied_to = [];
                var pubkeys_replied_to = [];
                var i; for ( i=0; i<event.tags.length; i++ ) {
                    if ( event[ "tags" ][ i ][ 0 ] == "e" ) {
                        events_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                    if ( event[ "tags" ][ i ][ 0 ] == "p" ) {
                        pubkeys_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                }
                if ( events_replied_to[ 0 ] ) {
                    var replyingTo = events_replied_to[ 0 ];
                }
                if ( !msg_cache[ parent ] ) {
                    msg_cache[ parent ] = [];
                }
                var event_time = event.created_at;
                var color = "";
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "e" || event.pubkey.substring( 0, 1 ) == "f" ) ) {
                    color = "red";
                }
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "c" || event.pubkey.substring( 0, 1 ) == "d" ) ) {
                    color = "pink";
                };
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "a" || event.pubkey.substring( 0, 1 ) == "b" ) ) {
                    color = "orange";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 10 ) {
                    color = "yellow";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 8 ) {
                    color = "green";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 6 ) {
                    color = "lightblue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 4 ) {
                    color = "blue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 2 ) {
                    color = "purple";
                };
                var name = pubkeyToNpub( event.pubkey ).substring( 0, 15 ) + "...";
                //var picture = "https://hashvatar.vercel.app/" + event.pubkey;
                var picture = "https://www.gravatar.com/avatar/" + event.pubkey + "?s=128&d=retro";
                if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                    name = namemap[ event.pubkey ];
                }
                name = DOMPurify.sanitize( name );
                if ( event.pubkey in imagemap && imagemap[ event.pubkey ] != "none" ) {
                    picture = imagemap[ event.pubkey ];
                }
                if ( !admin && window.nostr ) {
                    content = await window.nostr.nip04.decrypt( otherKey, content );
                } else {
                    content = await decrypt(privKey, otherKey, content)
                }
                content = content.replace( /&/g, "&#38;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" );
                content = markdownify( content, isMine );
                content = DOMPurify.sanitize( content );
                //If the current message is already in the message cache, return, otherwise add to the number of unread messages
                var messageIsKnown = false;
                msg_cache[ parent ].forEach( function( message, index ) {
                    if ( Object.keys( message )[ 0 ] == event.id ) {
                        messageIsKnown = true;
                    }
                });
                if ( !messageIsKnown ) {
                    addMessageToCache( event.pubkey, event.id, event_time, parent, color, name, picture, content );
                    if ( sessionStorage[ parent + "-counter" ] ) {
                        var messagecounter = Number( sessionStorage[ parent + "-counter" ] );
                    } else {
                        var messagecounter = 0;
                    }
                    messagecounter = messagecounter + 1;
                    sessionStorage[ parent + "-counter" ] = String( messagecounter );
                }
                if ( !messageIsKnown && document.getElementsByClassName( "channels" )[ 0 ] && document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ] ) {
                    if ( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].classList.contains( "active" ) ) return
                    var old_num_of_new_messages = Number( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getAttribute( "data-num-of-new-messages" ) );
                    new_num_of_new_messages = old_num_of_new_messages + 1;
                    document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].setAttribute( "data-num-of-new-messages", String( new_num_of_new_messages ) );
                    if ( new_num_of_new_messages > 0 ) {
                        document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText = String( new_num_of_new_messages );
                        if ( new_num_of_new_messages > 199 ) {
                            document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText += "+";
                        }
                        document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "notification" )[ 0 ].style.display = "inline";
                    }
                }
            }
            if ( kind == 1 && subId.includes( "00000005" ) ) {
                if ( JSON.parse( message[ "data" ] )[ 0 ] == "EOSE" ) return;
                if ( localStorage[ "local_pubkey_blacklist" ] ) {
                    var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
                } else {
                    var local_pubkey_blacklist = [];
                }
                if ( local_pubkey_blacklist.includes( event.pubkey ) ) return;
                var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
                var event_time = event.created_at;
                var how_long_ago = convertHMS( now - event_time );
                if ( now - event_time < -600 ) return;
                var isMine = ( event.pubkey == pubKey );
                if ( !isMine && !array_of_pubkeys.includes( event.pubkey ) ) {
                    array_of_pubkeys.push( event.pubkey );
                }
                var events_replied_to = [];
                var pubkeys_replied_to = [];
                var i; for ( i=0; i<event.tags.length; i++ ) {
                    if ( event[ "tags" ][ i ][ 0 ] == "e" ) {
                        events_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                    if ( event[ "tags" ][ i ][ 0 ] == "p" ) {
                        pubkeys_replied_to.push( event[ "tags" ][ i ][ 1 ] );
                    }
                }
                var parent = "globalfeed";
                var replyingTo = "";
                if ( events_replied_to[ 0 ] ) {
                    replyingTo = events_replied_to[ events_replied_to.length - 1 ];
                    array_of_replies.push( [ event.id, replyingTo ] );
                }
                content = content.replace( /&/g, "&#38;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" );
                var shortened_content = content.replace( /\n/g, " " ).substring( 0, 50 );
                shortened_content = DOMPurify.sanitize( shortened_content );
                if ( content.length > 50 ) {
                    shortened_content = shortened_content + "...";
                }
                content = markdownify( content, isMine );
                content = DOMPurify.sanitize( content );
                array_of_replies.forEach( function( item ) {
                    if ( item[ 0 ] == event.id ) {
                        var replyPubkey = event.pubkey;
                        if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                            var person_name = namemap[ event.pubkey ];
                        } else {
                            var person_name = replyPubkey.substring( 0, 15 );
                        }
                        if ( replyPubkey != pubKey ) {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + person_name + `</span>`;
                        } else {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + sessionStorage[ "my-name" ] + `</span>`;
                        }
                        replyContent = shortened_content;
                        if ( document.getElementsByClassName( item[ 0 ] )[ 0 ] ) {
                            document.getElementsByClassName( item[ 0 ] )[ 0 ].getElementsByClassName( "reply-prefix" )[ 0 ].innerHTML = replyAuthor + '<br>' + replyContent;
                        }
                    }
                });
                var color = "";
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "e" || event.pubkey.substring( 0, 1 ) == "f" ) ) {
                    color = "red";
                }
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "c" || event.pubkey.substring( 0, 1 ) == "d" ) ) {
                    color = "pink";
                };
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "a" || event.pubkey.substring( 0, 1 ) == "b" ) ) {
                    color = "orange";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 10 ) {
                    color = "yellow";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 8 ) {
                    color = "green";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 6 ) {
                    color = "lightblue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 4 ) {
                    color = "blue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 2 ) {
                    color = "purple";
                };
                var name = pubkeyToNpub( event.pubkey ).substring( 0, 15 ) + "...";
                //var picture = "https://hashvatar.vercel.app/" + event.pubkey;
                var picture = "https://www.gravatar.com/avatar/" + event.pubkey + "?s=128&d=retro";
                if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                    name = namemap[ event.pubkey ];
                }
                name = DOMPurify.sanitize( name );
                if ( event.pubkey in imagemap && imagemap[ event.pubkey ] != "none" ) {
                    picture = imagemap[ event.pubkey ];
                }
                if ( !msg_cache[ parent ] ) {
                    msg_cache[ parent ] = [];
                }
                if ( document.getElementsByClassName( parent )[ 0 ].classList.contains( "active" ) ) {
                    if ( document.getElementsByClassName( "message-header" )[ 0 ] && Number( document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                        document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                        document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                    }
                    if ( window.innerWidth < 601 && Number( document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                        document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                        document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                    }
                }
                if ( Number( document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].innerText = shortened_content;
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago );
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time );
                }
                //If the current message is not already in the message cache, add it, and also add to the number of unread messages
                var messageIsKnown = false;
                msg_cache[ parent ].forEach( function( message, index ) {
                    if ( Object.keys( message )[ 0 ] == event.id ) {
                        messageIsKnown = true;
                    }
                });
                if ( !messageIsKnown ) {
                    addMessageToCache( event.pubkey, event.id, event_time, parent, color, name, picture, content, replyingTo );
                    if ( !document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].classList.contains( "active" ) ) {
                        var old_num_of_new_messages = Number( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getAttribute( "data-num-of-new-messages" ) );
                        new_num_of_new_messages = old_num_of_new_messages + 1;
                        document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].setAttribute( "data-num-of-new-messages", String( new_num_of_new_messages ) );
                        if ( new_num_of_new_messages > 0 ) {
                            document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText = String( new_num_of_new_messages );
                            if ( new_num_of_new_messages > 199 ) {
                                document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText += "+";
                            }
                            document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( parent )[ 0 ].getElementsByClassName( "notification" )[ 0 ].style.display = "inline";
                        }
                    }
                }
                //if you are currently looking at the channel, add the message to the channel
                if ( !document.getElementsByClassName( parent )[ 0 ].classList.contains( "active" ) ) return;
                if ( document.getElementsByClassName( event.id )[ 0 ] ) return;
                var div = document.createElement( "div" );
                div.classList.add( "message" );
                div.classList.add( event.id );
                div.setAttribute( "data-author", event.pubkey );
                var what_for_reply = ( replyingTo ) ? replyingTo:event.pubkey;
                div.onclick = function() {msgContext( event.id, event.pubkey, what_for_reply, content );}
                if ( isMine ) {
                    div.align = "right";
                }
                if ( isMine ) {
                    var replyclass = "reply-in-blue";
                } else {
                    var replyclass = "reply-in-white";
                }
                var replyAuthor = `<span class="reply-author">${t('unknown')}</span>`;
                var replyPubkey = null;
                if ( document.getElementsByClassName( replyingTo )[ 0 ] ) {
                    replyPubkey = document.getElementsByClassName( replyingTo )[ 0 ].getAttribute( "data-author" );
                }
                if ( replyPubkey == pubKey ) {
                    replyAuthor = `<span class="reply-author">${sessionStorage[ "my-name" ]}</span>`;
                }
                var replyContent = `${t('replyToMessageNotFound')}`;
                var replyPrefix = "";
                if ( replyingTo && replyingTo != "" ) {
                    if ( document.getElementsByClassName( replyingTo )[ 0 ] && document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ] && document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "msgtext" )[ 0 ] ) {
                        if ( replyPubkey != pubKey ) {
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "author" )[ 0 ].innerHTML + `</span>`;
                        }
                        replyContent = document.getElementsByClassName( replyingTo )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].getElementsByClassName( "msgtext" )[ 0 ].innerText;
                        shortened_reply_content = replyContent.replace( /\n/g, " " ).substring( 0, 50 );
                        if ( replyContent.length > 50 ) {
                            shortened_reply_content = shortened_reply_content + "...";
                        }
                        replyContent = shortened_reply_content;
                    }
                    div.setAttribute( "data-replying-to", replyingTo );
                    replyPrefix = `<div class="reply-prefix ${replyclass}" onclick='document.getElementsByClassName( "${replyingTo}" )[ 0 ].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "0px 0px 25px 2px yellow";setTimeout( function() {document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "";}, 600 );event.stopPropagation();'>${replyAuthor}<br>${replyContent}</div>`
                }
                if ( isMine ) {
                    div.classList.add( "me" );
                    var html = `<div class="bubble" align="left">${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>`;
                    div.innerHTML = html;
                } else {
                    var html = `
                        <span class="picture" style="background-image: url('${picture}')" onclick="event.stopPropagation();showProfile( '${event.pubkey}', '${name}', '${picture}' )"></span>
                        <div class="bubble"><div class="author ${color} ${event.pubkey}">${name}</div>${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>
                    `;
                    div.innerHTML = html;
                }
                document.getElementsByClassName( "message-content" )[ 0 ].append( div );
                var last_200_messages = [];
                var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                    last_200_messages.push( document.getElementsByClassName( "bubble" )[ i ].parentElement );
                }
                last_200_messages.sort(function( a, b ) {return b.getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) - a.getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" )});
                var i; for ( i=0; i<document.getElementsByClassName( "bubble" ).length; i++ ) {
                    document.getElementsByClassName( "bubble" )[ i ].parentElement.remove();
                    i = i - 1;
                }
                last_200_messages.reverse();
                last_200_messages.forEach( function( item ) {
                    document.getElementsByClassName( "message-content" )[ 0 ].append( item );
                    document.querySelectorAll( "a" ).forEach( function( a ) {if ( a.rel ) {a.target="_blank"}});
                });
                //scroll to bottom if near bottom, otherwise not
                if ( window.innerWidth < 601 ) {
                    var scrollto = document.getElementsByClassName( "content" )[ 0 ].scrollTop;
                    var offset = 0;
                    if ( document.getElementsByClassName( "message-content" )[ 0 ] && document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" )[ 0 ] ) {
                        offset = document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" )[ document.getElementsByClassName( "message-content" )[ 0 ].getElementsByClassName( "message" ).length - 1 ].offsetHeight;
                    }
                    if ( offset > 20 ) {
                        offset = offset - 20;
                    }
                    if ( ( document.getElementsByClassName( "content" )[ 0 ].scrollHeight - document.getElementsByClassName( "content" )[ 0 ].scrollTop ) > 1500 ) {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTo( 0, scrollto + offset );
                    } else {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                        if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                            document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                        }
                    }
                } else {
                    if ( ( document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight - document.getElementsByClassName( "message-content" )[ 0 ].scrollTop ) > 1500 ) {
                        return
                    } else {
                        document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                        if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                            document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                        }
                    }
                }
            }
        }

        socket.addEventListener( 'message', handleMessage );

        async function openConnection( e ) {
            getWallet();
            getGlobalMessages();
            if ( !admin && window.nostr ) {
                pubKey = await window.nostr.getPublicKey();
                privKey = "";
            }
            forceUpdateUserMeta( pubKey );
            addDmsToSidebar();
            var subId   = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" )
            var filter  = { "ids": subscribed_channels }
            var subscription = [ "REQ", subId, filter ]
            socket.send(JSON.stringify( subscription ));
            var i; for ( i=0; i<document.getElementsByClassName( "channel-outer" ).length; i++ ) {
                //get latest messages for all known channels in case this is a reconnection
                getLatestMessage( document.getElementsByClassName( "channel-outer" )[ i ].getAttribute( "data-id" ) );
            }
            //give users open dms
            var openSubId   = "encrypted-open-dms" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
            sessionStorage[ "encrypted-open-dms" ] = openSubId;
            var openFilter  = {
                "kinds": [ 4 ],
                "#p": [ pubKey ],
                "limit": 200
            }
            var openSubscription = [ "REQ", openSubId, openFilter ]
            var sendable = JSON.stringify( openSubscription )
            socket.send( sendable );
            if ( document.getElementsByClassName( "active" )[ 0 ] ) {
                if ( document.getElementsByClassName( "active" )[ 0 ].classList.contains( "channel-outer" ) ) {
                    var id = document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-id" );
                    setTimeout( function() {addMessages( id );}, 3000 );
                }
                if ( document.getElementsByClassName( "active" )[ 0 ].classList.contains( "dm-outer" ) ) {
                    var pubkey = document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" );
                    addClosedDecryptedMessages( pubkey );
                }
            }
        }

        socket.addEventListener( 'open', openConnection );

        function forceUpdateUserMeta( pubkey ) {
            var newsubId   = "00000001" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 );
            var newfilter  = { "authors": [ pubkey ], "kinds": [0], "limit": 1 }
            var newsubmo = [ "REQ", newsubId, newfilter ]
            socket.send(JSON.stringify( newsubmo ));
            setTimeout( function() {
                var closer = [ "CLOSE", newsubId ];
                socket.send(JSON.stringify( closer ));
            }, 1500 );
        }

        async function getSignedEvent(event, privateKey) {
            var eventArray = [
                0,                    // Reserved for future use
                event['pubkey'],        // The sender's public key
                event['created_at'],    // Unix timestamp
                event['kind'],        // Message “kind” or type
                event['tags'],        // Tags identify replies/recipients
                event['content']        // Your note contents
            ];
            var eventData = JSON.stringify( eventArray );
            event.id  = sha256( eventData ).toString( 'hex' )
            if ( !admin && window.nostr ) {
                var signedEvent = await window.nostr.signEvent( event );
                if ( typeof( signedEvent ) == "string" ) {
                    event.sig = signedEvent;
                } else {
                    event.sig = signedEvent.sig;
                }
            } else {
                event.sig = await schnorr.sign( event.id, privateKey ) 
            }
            return event
        }
        function hexToBytes( hex ) {
            return Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
        }

        function bytesToHex( bytes ) {
            return bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, '0' ), '' );
        }
        function base64ToHex( str ) {
            var raw = atob( str );
            var result = '';
            var i; for ( i=0; i<raw.length; i++ ) {
                var hex = raw.charCodeAt( i ).toString( 16 );
                result += ( hex.length === 2 ? hex : '0' + hex );
            }
            return result;
        }
        function encrypt( privkey, pubkey, text ) {
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var iv = window.crypto.getRandomValues(new Uint8Array(16));
            var cipher = browserifyCipher.createCipheriv( 'aes-256-cbc', hexToBytes( key ), iv );
            var encryptedMessage = cipher.update(text,"utf8","base64");
            emsg = encryptedMessage + cipher.final( "base64" );
            var uint8View = new Uint8Array( iv.buffer );
            var decoder = new TextDecoder();
            return emsg + "?iv=" + btoa( String.fromCharCode.apply( null, uint8View ) );
        }
        function decrypt( privkey, pubkey, ciphertext ) {
            var [ emsg, iv ] = ciphertext.split( "?iv=" );
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var decipher = browserifyCipher.createDecipheriv(
                'aes-256-cbc',
                hexToBytes( key ),
                hexToBytes( base64ToHex( iv ) )
            );
            var decryptedMessage = decipher.update( emsg, "base64", "utf8" );
            dmsg = decryptedMessage + decipher.final( "utf8" );
            return dmsg;
        }
    </script>
    <script>
        function waitSomeSeconds( num ) {
            var num = num.toString() + "000";
            num = Number( num );
            return new Promise( function( resolve, reject ) {
                setTimeout( function() { resolve( "" ); }, num );
            });
        }

        function isValidJson( content ) {
            try {
                var json = JSON.parse( content );
            } catch ( e ) {
                return false;
            }
            return true;
        }

        async function dupNote( getrelay, note ) {
            var mysocket = new WebSocket( getrelay );
            var id = "";
            mysocket.addEventListener( 'open', async function open() {
                mysocket.send( note );
                possible_id = JSON.parse( note )[ 1 ][ "id" ];
                var is_set = await getNote( getrelay, id );
                if ( is_set ) {
                    id = possible_id;
                }
                setTimeout( function() {mysocket.close();}, 300 );
            });
            async function isNoteSetYet( note_i_seek ) {
              return new Promise( function( resolve, reject ) {
                    if ( note_i_seek == "" ) {
                        setTimeout( async function() {
                            var msg = await isNoteSetYet( id );
                            resolve( msg );
                        }, 100 );
                    } else {
                        resolve( note_i_seek );
                    }
                });
            }
            async function getTimeoutData() {
                var note_i_seek = await isNoteSetYet( id );
                return note_i_seek;
            }
            var returnable = await getTimeoutData();
            return returnable;
        }

        async function setNote( getrelay, note ) {
                var mysocket = new WebSocket( getrelay );
                var id = "";
                mysocket.addEventListener( 'open', function open() {
                        function makeNote( note, recipientpubkey ) {
                                var now = Math.floor( ( new Date().getTime() ) / 1000 );
                                var newevent = [
                                        0,
                                        pubKey,
                                        now,
                                        70202,
                                        [],
                                        note
                                ];
                                var message = JSON.stringify( newevent );
                                var msghash = sha256( message ).toString( "hex" );
                                nobleSecp256k1.schnorr.sign( buffer.Buffer.from( msghash, "hex" ), privKey ).then(
                                        value => {
                                                sig = buffer.Buffer.from( value ).toString( "hex" );
                                                nobleSecp256k1.schnorr.verify(
                                                        sig,
                                                        msghash,
                                                        pubKey
                                                ).then(
                                                        value => {
                                                                if ( value ) {
                                                                        var fullevent = {
                                                                                "id": msghash,
                                                                                "pubkey": pubKey,
                                                                                "created_at": now,
                                                                                "kind": 70202,
                                                                                "tags": [],
                                                                                "content": note,
                                                                                "sig": sig
                                                                        }
                                                                        var sendable = [ "EVENT", fullevent ];
                                                                        sendable = JSON.stringify( sendable );
                                                                        mysocket.send( sendable );
                                                                        id = msghash;
                                                                        setTimeout( function() {mysocket.close();}, 300 );
                                                                 }
                                                        }
                                               );
                                        }
                                );
                        }
                        makeNote( note, pubKey );
                });
                async function isNoteSetYet( note_i_seek ) {
                  return new Promise( function( resolve, reject ) {
                            if ( note_i_seek == "" ) {
                                    setTimeout( async function() {
                                            var msg = await isNoteSetYet( id );
                                            resolve( msg );
                                    }, 100 );
                            } else {
                                    resolve( note_i_seek );
                            }
                    });
                }
                async function getTimeoutData() {
                    var note_i_seek = await isNoteSetYet( id );
                    return note_i_seek;
                }
                var returnable = await getTimeoutData();
                return returnable;
        }

        async function getNote( getrelay, id ) {
            var timer = 0;
            var mysocket = new WebSocket( getrelay );
            var note = "";
            mysocket.addEventListener( 'error', async function( event ) {
                note = "none";
            });
            mysocket.addEventListener( 'message', async function( event ) {
                if ( event[ "data" ] && isValidJson( event[ "data" ] ) && JSON.parse( event[ "data" ] )[ 0 ] && JSON.parse( event[ "data" ] )[ 0 ] == "EVENT" ) {
                        note = ( JSON.parse( event[ "data" ] )[ 2 ] );
                }
            });
            mysocket.addEventListener( 'open', function open() {
                var filter = {
                    "ids": [
                        id
                    ]
                }
                var subscription = [ "REQ", "test", filter ];
                subscription = JSON.stringify( subscription );
                var chaser = [ "CLOSE", "test" ];
                chaser = JSON.stringify( chaser );
                mysocket.send( subscription );
                setTimeout( function() {mysocket.send( chaser );}, 1000 );
                setTimeout( function() {mysocket.close();}, 2000 );
            });
            async function isNoteSetYet( note_i_seek ) {
                timer = timer + 1;
                if ( timer == 20 ) {
                    note = "none";
                }
                return new Promise( function( resolve, reject ) {
                    if ( note_i_seek == "" ) {
                        setTimeout( async function() {
                            var msg = await isNoteSetYet( note );
                            resolve( msg );
                        }, 100 );
                    } else {
                        resolve( note_i_seek );
                    }
                });
            }
            async function getTimeoutData() {
                var note_i_seek = await isNoteSetYet( note );
                return note_i_seek;
            }
            var returnable = await getTimeoutData();
            return returnable;
        }

        var stage_1_relays = [
            "wss://no.str.cr",
            "wss://relay.sovereign-stack.org",
            "wss://relay.farscapian.com",
            "wss://relay.oldcity-bitcoiners.info",
            "wss://nostr-2.zebedee.cloud",
            "wss://nostr.fly.dev",
            "wss://relay.nostr.ch",
            "wss://nostr.zebedee.cloud",
            "wss://nostr-relay.lnmarkets.com",
            "wss://relay.nostr.pro",
            "wss://relay.r3d.red",
            "wss://nostr.rdfriedl.com",
            "wss://relay.cryptocculture.com",
            "wss://nostr-pub.wellorder.net",
            "wss://nostr-verified.wellorder.net",
            "wss://nostr.rocks",
            "wss://relay.damus.io",
            "wss://nostr.drss.io",
            "wss://nostr.bitcoiner.social",
            "wss://nostr-relay.wlvs.space",
            "wss://nostr-relay.untethr.me",
            "wss://expensive-relay.fiatjaf.com",
            "wss://nostr-relay.freeberty.net",
            "wss://relay.minds.com/nostr/v1/ws"
        ];
        var stage_2_relays = [];
        var stage_3_relays = [];
        var stage_1_relays_tested = [];
        var stage_2_relays_tested = [];
        async function passThroughStage( myrelay, num ) {
            if ( num == 1 ) {
                if ( stage_1_relays_tested.length < stage_1_relays.length && !stage_1_relays_tested.includes( myrelay ) ) {
                    stage_1_relays_tested.push( myrelay );
                }
                //console.log( "number of stage", num, "relays tested:", stage_1_relays_tested.length, "out of", stage_1_relays.length );
                var note = await getNote( myrelay, "25e5c82273a271cb1a840d0060391a0bf4965cafeb029d5ab55350b418953fbb" );
                if ( note != "none" && !stage_2_relays.includes( myrelay ) ) {
                    stage_2_relays.push( myrelay );
                }
                if ( stage_1_relays_tested.length == stage_1_relays.length ) {
                    testSocketsStage2();
                }
            }
            if ( num == 2 ) {
                if ( stage_2_relays_tested.length < stage_2_relays.length && !stage_2_relays_tested.includes( myrelay ) ) {
                    stage_2_relays_tested.push( myrelay );
                }
                //console.log( "number of stage", num, "relays tested:", stage_2_relays_tested.length, "out of", stage_2_relays.length );
                var id = await setNote( myrelay, "test" );
                var is_set = await getNote( myrelay, id );
                if ( note != "none" && !stage_3_relays.includes( myrelay ) ) {
                    stage_3_relays.push( myrelay );
                }        
                if ( stage_2_relays_tested.length == stage_2_relays.length ) {
                    testSocketsStage1();
                }
            }
        }
        async function testSocketsStage1() {
            stage_1_relays_tested = [];
            stage_2_relays = [];
            var i; for ( i=0; i<stage_1_relays.length; i++ ) {
                passThroughStage( stage_1_relays[ i ], 1 );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
        async function testSocketsStage2() {
            stage_2_relays_tested = [];
            stage_3_relays = [];
            var i; for ( i=0; i<stage_2_relays.length; i++ ) {
                passThroughStage( stage_2_relays[ i ], 2 );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
        //testSocketsStage1();
    </script>
    <script>
        function displayChannel( image, name, message, id, timestamp ) {
            var old_num_of_new_messages = 0;
            if ( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( id )[ 0 ] ) {
                old_num_of_new_messages = document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( id )[ 0 ].getAttribute( "data-num-of-new-messages" );
                old_num_of_new_messages = Number( old_num_of_new_messages );
            }
            var html = `
                        <li class="channel-outer ${id}" data-id="${id}" data-img="${image}" data-num-of-new-messages="${String( old_num_of_new_messages )}" onclick="selectChannel( this );">
                            <a>
                                <span style="background-image: url('${image}')"></span>
                                <div class="channel-inner">
                                    <div class="name">${name}</div>
                                    <div data-timestamp="${timestamp}" class="message">${message}</div>
                                </div>
                                <span class="notification">${String( old_num_of_new_messages )}</span>
                            </a>
                        </li>
            `;
            return html;
        }
    </script>
    <script>
        function selectChannel( channel ) {
            sessionStorage[ "scrolled" ] = false;
            array_of_replies = [];
            channel.getElementsByClassName( "notification" )[ 0 ].style.display = "none";
            channel.getElementsByClassName( "notification" )[ 0 ].innerText = "0";
            channel.setAttribute( "data-num-of-new-messages", "0" );
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( channel.getAttribute( "data-id" ) )[ 0 ].classList.add( "active" );
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span style="background-image: url('${channel.getAttribute( "data-img" )}')"></span>
                        <div class="channel-wrapper">
                            <div class="name">${channel.getElementsByClassName( "name" )[ 0 ].innerText}</div>
                            <div data-timestamp="${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" )}" class="time">${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestring" )}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="info-circle">
                                <a>
                                    <i class="fa fa-info-circle"></i>
                                </a>
                            </li>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="infobox">
                    <span class="infobox-text">${t('channelId')}: ${channel.getAttribute( "data-id" )}<br>URL: ${window.location.protocol + "//" + window.location.hostname + window.location.pathname + "?channel=" + channel.getAttribute( "data-id" )}</span>
                    <span class="infobox-x">&times;</span>
                </div>
                <div class="message-content">
                </div>
                <div class="message-form">
                    <div class="reply-div"></div>
                    <ul>
                        <li class="emoji-btn" onclick="showEmojis( 0 )">
                            <a>
                                <i class="fa fa-laugh"></i>
                            </a>
                        </li>
                        <li class="input">
                            <textarea class="note-input" rows="1" cols="70" type="text" placeholder="${t('saySomething')}" onfocus='setTimeout( function() {if ( window.innerWidth < 601 && ( window.innerHeight < Number( sessionStorage[ "full-window-height" ] ) * 0.9 ) ) {sessionStorage[ "keyboard_is_open" ] = String( 1 );var size_difference = Number( sessionStorage[ "full-window-height" ] ) - window.innerHeight;if ( !sessionStorage[ "keyboard_size" ] ) {sessionStorage[ "keyboard_size" ] = String( size_difference );}var current_height = document.getElementsByClassName( "content" )[ 0 ].scrollTop;var new_height = current_height + size_difference + 50;var max_height = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;if ( new_height > max_height ) {new_height = max_height;} document.getElementsByClassName( "content" )[ 0 ].scrollTo({top: new_height, left: 0, behavior: "smooth"});}}, 600 );'></textarea>
                        </li>
                        <li class="send-btn">
                            <a>
                                <i class="fa fa-paper-plane"></i>
                            </a>
                        </li>
                        <li class="sound-btn">
                            <a>
                                <i class="fa fa-microphone"></i>
                            </a>
                        </li>
                        <li class="image-btn">
                            <a>
                                <i class="fa fa-image"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span style="background-image: url('${channel.getAttribute( "data-img" )}')"></span>
                        <div class="channel-wrapper">
                            <div class="name">${channel.getElementsByClassName( "name" )[ 0 ].innerText}</div>
                            <div data-timestamp="${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" )}" class="time">${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestring" )}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="info-circle">
                                <a>
                                    <i class="fa fa-info-circle"></i>
                                </a>
                            </li>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="infobox">
                    Channel id: ${channel.getAttribute( "data-id" )}
                    <span class="infobox-x">&times;</span>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            } else {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "block";
                document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                    document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                }
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "info-circle" )[ 0 ].addEventListener( "click", function() {
                document.getElementsByClassName( "infobox" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "infobox-x" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "infobox" )[ 0 ].style.display = "none";
                })
            });
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPublic );
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPublic );
            document.getElementsByClassName( "sound-btn" )[ 0 ].addEventListener( "click", function() {showToast( `${t('comingSoon')}` );});
            document.getElementsByClassName( "image-btn" )[ 0 ].addEventListener( "click", function() {
                showImgs();
            });
            addMessages( channel.getAttribute( "data-id" ) );
        }
    </script>
    <script>
        function enterSendPublic( e ) {
            if ( e.key === 'Enter' && !isShiftDown() ) {
                sendNote();
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].focus();
                    document.getElementsByClassName( "note-input" )[ 0 ].select();
                }
            }
        }
    </script>
    <script>
        function enterSendPublicWithReply( e ) {
            if ( e.key === 'Enter' && !isShiftDown() ) {
                var event_id = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-event-id" );
                var pubkey = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-pubkey" );
                sendNoteWithReply( event_id, pubkey );
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].focus();
                    document.getElementsByClassName( "note-input" )[ 0 ].select();
                }
            }
        }
    </script>
    <script>
        function clickSendPublicWithReply( e ) {
            keymap[ "Shift" ] = false;
            var event_id = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-event-id" );
            var pubkey = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-pubkey" );
            sendNoteWithReply( event_id, pubkey );
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
        }
    </script>
    <script>
        function clickSendPublic( e ) {
            keymap[ "Shift" ] = false;
            sendNote();
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
        }
    </script>
    <script>
        function clickSendGlobal( e ) {
            keymap[ "Shift" ] = false;
            sendGlobalNote();
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
        }
    </script>
    <script>
        function enterSendGlobal( e ) {
            if ( e.key === 'Enter' && !isShiftDown() ) {
                sendGlobalNote();
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].focus();
                    document.getElementsByClassName( "note-input" )[ 0 ].select();
                }
            }
        }
    </script>
    <script>
        function enterSendGlobalWithReply( e ) {
            if ( e.key === 'Enter' && !isShiftDown() ) {
                var event_id = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-event-id" );
                var pubkey = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-pubkey" );
                sendGlobalNoteWithReply( event_id, pubkey );
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].focus();
                    document.getElementsByClassName( "note-input" )[ 0 ].select();
                }
            }
        }
    </script>
    <script>
        function clickSendGlobalWithReply( e ) {
            keymap[ "Shift" ] = false;
            var event_id = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-event-id" );
            var pubkey = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-pubkey" );
            sendGlobalNoteWithReply( event_id, pubkey );
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
        }
    </script>
    <script>
        function addMessages( id ) {
            var cached_messages = msg_cache[ id ];
            var time_for_since = 0;
            cached_messages.forEach( function( msg, i ) {
                if ( document.getElementsByClassName( msg[ Object.keys( msg )[ 0 ] ][ "id" ] )[ 0 ] ) return;
                var color = msg[ Object.keys( msg )[ 0 ] ][ "color" ];
                var content = msg[ Object.keys( msg )[ 0 ] ][ "content" ];
                if ( content.length > 3000 ) return;
                var event_time = msg[ Object.keys( msg )[ 0 ] ][ "event_time" ];                
                var id = msg[ Object.keys( msg )[ 0 ] ][ "id" ];
                var name = msg[ Object.keys( msg )[ 0 ] ][ "name" ];
                var parent = msg[ Object.keys( msg )[ 0 ] ][ "parent" ];
                var picture = msg[ Object.keys( msg )[ 0 ] ][ "picture" ];
                var pubkey = msg[ Object.keys( msg )[ 0 ] ][ "pubkey" ];
                if ( localStorage[ "local_pubkey_blacklist" ] ) {
                    var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
                } else {
                    var local_pubkey_blacklist = [];
                }
                if ( local_pubkey_blacklist.includes( pubkey ) ) return;
                var replyingTo = "";
                if ( "replyingTo" in msg[ Object.keys( msg )[ 0 ] ] ) {
                    replyingTo = msg[ Object.keys( msg )[ 0 ] ][ "replyingTo" ];
                }
                var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
                var how_long_ago = convertHMS( now - event_time );
                if ( now - event_time < -600 ) return;
                var div = document.createElement( "div" );
                if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                    name = namemap[ pubkey ];
                }
                if ( pubkey in imagemap && imagemap[ pubkey ] != "none" ) {
                    picture = imagemap[ pubkey ];
                }
                name = DOMPurify.sanitize( name );
                div.classList.add( "message" );
                div.classList.add( id );
                var isMine = ( pubkey == pubKey );
                div.setAttribute( "data-author", pubkey );
                if ( isMine ) {
                    div.align = "right";
                }
                var what_for_reply = ( replyingTo ) ? replyingTo:pubkey;
                div.onclick = function() {msgContext( id, pubkey, what_for_reply, content );}
                if ( isMine ) {
                    var replyclass = "reply-in-blue";
                } else {
                    var replyclass = "reply-in-white";
                }
                var replyAuthor = `<span class="reply-author">${t('unknown')}</span>`;
                var replyContent = `${t('replyToMessageNotFound')}`;
                var replyPrefix = "";
                if ( replyingTo && replyingTo != "" ) {
                    cached_messages.forEach( function( item ) {
                        if ( item[ replyingTo ] ) {
                            var replyPubkey = item[ replyingTo ][ "pubkey" ];
                            replyAuthor = `<span class="reply-author ${replyPubkey}">` + item[ replyingTo ][ "name" ] + `</span>`;
                            replyContent = item[ replyingTo ][ "content" ].replace( /&/g, "&#38;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" );
                            shortened_reply_content = replyContent.replace( /\n/g, " " ).substring( 0, 50 );
                            if ( replyContent.length > 50 ) {
                                shortened_reply_content = shortened_reply_content + "...";
                            }
                            replyContent = shortened_reply_content;
                        }
                    });
                    div.setAttribute( "data-replying-to", replyingTo );
                    replyPrefix = `<div class="reply-prefix ${replyclass}" onclick='document.getElementsByClassName( "${replyingTo}" )[ 0 ].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "0px 0px 25px 2px yellow";setTimeout( function() {document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "";}, 600 );event.stopPropagation();'>${replyAuthor}<br>${replyContent}</div>`
                }
                if ( isMine ) {
                    div.classList.add( "me" );
                    var html = `<div class="bubble" align="left">${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>`;
                    div.innerHTML = html;
                } else {
                    var html = `
                        <span class="picture" style="background-image: url('${picture}')" onclick="event.stopPropagation();showProfile( '${pubkey}', '${name}', '${picture}' )"></span>
                        <div class="bubble"><div class="author ${color} ${pubkey}">${name}</div>${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>
                    `;
                    div.innerHTML = html;
                }
                if ( now - event_time > 15 ) {
                    document.getElementsByClassName( "message-content" )[ 0 ].prepend( div );
                } else {
                    document.getElementsByClassName( "message-content" )[ 0 ].append( div );
                }
                document.querySelectorAll( "a" ).forEach( function( a ) {if ( a.rel ) {a.target="_blank"}});
                if ( document.getElementsByClassName( "message-header" )[ 0 ] && Number( document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                }
                if ( Number( document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago );
                }
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                } else {
                    document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                }
                if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                    document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                }
            });
        }
    </script>
    <script>
        //this code runs whenever a dm is clicked, it should also work for "closed dms" where you only see someone's dms if you first add them to your sidebar
        function addClosedDecryptedMessages( pubkey ) {
            if ( msg_cache[ pubkey ] ) {
                var cached_messages = msg_cache[ pubkey ];
                var time_for_since = 0;
                cached_messages.forEach( function( msg, i ) {
                    var color = msg[ Object.keys( msg )[ 0 ] ][ "color" ];
                    var content = msg[ Object.keys( msg )[ 0 ] ][ "content" ];
                    var event_time = msg[ Object.keys( msg )[ 0 ] ][ "event_time" ];                
                    var id = msg[ Object.keys( msg )[ 0 ] ][ "id" ];
                    var name = msg[ Object.keys( msg )[ 0 ] ][ "name" ];
                    var parent = msg[ Object.keys( msg )[ 0 ] ][ "parent" ];
                    var picture = msg[ Object.keys( msg )[ 0 ] ][ "picture" ];
                    var pubkey = msg[ Object.keys( msg )[ 0 ] ][ "pubkey" ];
                    var replyingTo = "";
                    if ( "replyingTo" in msg[ Object.keys( msg )[ 0 ] ] ) {
                        replyingTo = msg[ Object.keys( msg )[ 0 ] ][ "replyingTo" ];
                    }
                    var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
                    var how_long_ago = convertHMS( now - event_time );
                    if ( now - event_time < -600 ) return;
                    var div = document.createElement( "div" );
                    if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                        name = namemap[ pubkey ];
                    }
                    if ( pubkey in imagemap && imagemap[ pubkey ] != "none" ) {
                        picture = imagemap[ pubkey ];
                    }
                    div.classList.add( "message" );
                    div.classList.add( id );
                    var isMine = ( pubkey == pubKey );
                    div.setAttribute( "data-author", pubkey );
                    if ( isMine ) {
                        div.align = "right";
                    }
                    var what_for_reply = ( replyingTo ) ? replyingTo:pubkey;
                    div.onclick = function() {msgContext( id, pubkey, what_for_reply, content );}
                    var replyAuthor = `<span class="reply-author">${t('unknown')}</span>`;
                    var replyContent = `${t('replyToMessageNotFound')}`;
                    var replyPrefix = "";
                    if ( isMine ) {
                        var replyclass = "reply-in-blue";
                    } else {
                        var replyclass = "reply-in-white";
                    }
                    if ( replyingTo && replyingTo != "" ) {
                        cached_messages.forEach( function( item ) {
                            if ( item[ replyingTo ] ) {
                                var replyPubkey = item[ replyingTo ][ "pubkey" ];
                                replyAuthor = `<span class="reply-author ${replyPubkey}">` + item[ replyingTo ][ "name" ] + `</span>`;
                                replyContent = item[ replyingTo ][ "content" ].replace( /&/g, "&#38;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" );
                                shortened_reply_content = replyContent.replace( /\n/g, " " ).substring( 0, 50 );
                                if ( replyContent.length > 50 ) {
                                    shortened_reply_content = shortened_reply_content + "...";
                                }
                                replyContent = shortened_reply_content;
                            }
                        });
                        div.setAttribute( "data-replying-to", replyingTo );
                        replyPrefix = `<div class="reply-prefix ${replyclass}" onclick='document.getElementsByClassName( "${replyingTo}" )[ 0 ].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "0px 0px 25px 2px yellow";setTimeout( function() {document.getElementsByClassName( "${replyingTo}" )[ 0 ].getElementsByClassName( "bubble" )[ 0 ].style.boxShadow = "";}, 600 );event.stopPropagation();'>${replyAuthor}<br>${replyContent}</div>`
                    }
                    if ( isMine ) {
                        div.classList.add( "me" );
                        var html = `<div class="bubble" align="left">${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>`;
                        div.innerHTML = html;
                    } else {
                        var html = `
                            <span class="picture" style="background-image: url('${picture}')" onclick="event.stopPropagation();showProfile( '${pubkey}', '${name}', '${picture}' )"></span>
                            <div class="bubble"><div class="author ${color} ${pubkey}">${name}</div>${replyPrefix}<div class="msgtext">${content}</div><div data-timestamp="${event_time}" class="time bubbletime">${how_long_ago}</div></div>
                        `;
                        div.innerHTML = html;
                    }
                    if ( now - event_time > 15 ) {
                        document.getElementsByClassName( "message-content" )[ 0 ].prepend( div );
                    } else {
                        document.getElementsByClassName( "message-content" )[ 0 ].append( div );
                    }
                    if ( document.getElementsByClassName( "message-header" )[ 0 ] && Number( document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                        document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                        document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                    }
                    if ( window.innerWidth < 601 && Number( document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                        document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                        document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                    }
                    if ( Number( document.getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" ) ) < Number( event_time ) ) {
                        document.getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time );
                        document.getElementsByClassName( parent.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago );
                    }
                    if ( window.innerWidth < 601 ) {
                        document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                    } else {
                        document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                    }
                    if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                        document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                    }
                    if ( i == cached_messages.length - 1 ) {
                        time_for_since = event_time - 5;
                    }
                });
            }
            var closedSubId   = "encrypted-dms" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
            sessionStorage[ "encrypted-dms-subid" ] = closedSubId;
            var closedFilter  = {
                "authors": [ pubKey, pubkey ],
                "kinds": [ 4 ],
                "#p": [ pubKey, pubkey ],
                "since": time_for_since,
                "limit": 200
            }
            var closedSubscription = [ "REQ", closedSubId, closedFilter ]
            socket.send(JSON.stringify( closedSubscription ));
        }
    </script>
    <script>
        function getLatestMessage( id ) {
            var subId   = "latest-message" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
            var filter  = {
                "kinds": [ 42 ],
                "#e": [id],
                "limit": 200
            }
            var subscription = [ "REQ", subId, filter ];
            socket.send(JSON.stringify( subscription ));
        }
    </script>
    <script>
        function getGlobalMessages() {
            var subId   = "00000005" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
            var filter  = {
                "kinds": [ 1 ],
                "limit": 200
            }
            var subscription = [ "REQ", subId, filter ];
            socket.send(JSON.stringify( subscription ));
        }
    </script>
    <script>
        async function sendNote() {
            var note = document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value;
            if ( !note || note == "" ) return;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            var id = document.getElementsByClassName( "channel-outer active" )[ 0 ].getAttribute( "data-id" );
            var event = {
                "content"    : note,
                "created_at" : now,
                "kind"       : 42,
                "tags"       : [ [ "e", id ] ],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent( event, privKey );
            socket.send( JSON.stringify( [ "EVENT", signedEvent ] ) );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        async function sendGlobalNote() {
            var note = document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value;
            if ( !note || note == "" ) return;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            var event = {
                "content"    : note,
                "created_at" : now,
                "kind"       : 1,
                "tags"       : [],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent( event, privKey );
            socket.send( JSON.stringify( [ "EVENT", signedEvent ] ) );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        async function sendNoteWithReply( id_of_post_being_replied_to, pubkey_of_person_being_replied_to ) {
            var note = document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value;
            if ( !note || note == "" ) return;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            var id = document.getElementsByClassName( "channel-outer active" )[ 0 ].getAttribute( "data-id" );
            var event = {
                "content"    : note,
                "created_at" : now,
                "kind"       : 42,
                "tags"       : [ [ "e", id ], [ "e", id_of_post_being_replied_to ], [ "p", pubkey_of_person_being_replied_to ] ],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent( event, privKey );
            socket.send( JSON.stringify( [ "EVENT", signedEvent ] ) );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
            document.getElementsByClassName( "reply-div" )[ 0 ].style.display = "none";
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendPublicWithReply );
            document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendPublicWithReply );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPublic );
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPublic );
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        async function sendGlobalNoteWithReply( id_of_post_being_replied_to, pubkey_of_person_being_replied_to ) {
            var note = document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value;
            if ( !note || note == "" ) return;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            var event = {
                "content"    : note,
                "created_at" : now,
                "kind"       : 1,
                "tags"       : [ [ "e", id_of_post_being_replied_to ], [ "p", pubkey_of_person_being_replied_to ] ],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent( event, privKey );
            socket.send( JSON.stringify( [ "EVENT", signedEvent ] ) );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
            document.getElementsByClassName( "reply-div" )[ 0 ].style.display = "none";
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendGlobalWithReply );
            document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendGlobalWithReply );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendGlobal );
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendGlobal );
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        async function sendEncryptedNote( note, pubkey ) {
            if ( !note || note == "" ) return;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            if ( !admin && window.nostr ) {
                var encrypted = await window.nostr.nip04.encrypt( pubkey, note );
            } else {
                var encrypted = encrypt( privKey, pubkey, note );
            }
            var event = {
                "content"    : encrypted,
                "created_at" : now,
                "kind"       : 4,
                "tags"       : [ [ 'p', pubkey ] ],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent( event, privKey );
            socket.send( JSON.stringify( [ "EVENT", signedEvent ] ) );
            if ( document.getElementsByClassName( "input" )[ 0 ] && document.getElementsByClassName( "input" )[ 0 ].firstElementChild ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
            }
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        async function sendEncryptedNoteWithReply( note, pubkey, id_of_post_being_replied_to, pubkey_of_person_being_replied_to ) {
            if ( !note || note == "" ) return;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            if ( !admin && window.nostr ) {
                var encrypted = await window.nostr.nip04.encrypt( pubkey, note );
            } else {
                var encrypted = encrypt( privKey, pubkey, note );
            }
            var event = {
                "content"    : encrypted,
                "created_at" : now,
                "kind"       : 4,
                "tags"       : [ [ 'p', pubkey ], [ 'e', id_of_post_being_replied_to ] ],
                "pubkey"     : pubKey,
            }
            if ( pubkey != pubkey_of_person_being_replied_to ) {
                event[ "tags" ].push( [ 'p', pubkey_of_person_being_replied_to ] );
            }
            var signedEvent = await getSignedEvent( event, privKey );
            socket.send( JSON.stringify( [ "EVENT", signedEvent ] ) );
            if ( document.getElementsByClassName( "input" )[ 0 ] && document.getElementsByClassName( "input" )[ 0 ].firstElementChild ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
            }
            document.getElementsByClassName( "reply-div" )[ 0 ].style.display = "none";
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendPrivateWithReply );
            document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendPrivateWithReply );
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPrivate );
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPrivate );
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        function convertHMS( value ) {
            if ( value < 0 ) {
                value = 0;
            }
            const sec = parseInt(value, 10); // convert value to number if it's string
            let years   = Math.floor(sec / 31536000); // get years
            let months  = Math.floor((sec - (years * 31536000)) / 2592000); // get months
            let days    = Math.floor((sec - (years * 31536000) - (months * 2592000)) / 86400); // get days
            let hours   = Math.floor((sec - (years * 31536000) - (months * 2592000) - (days * 86400)) / 3600); // get hours
            let minutes = Math.floor((sec - (years * 31536000) - (months * 2592000) - (days * 86400) - (hours * 3600)) / 60); // get minutes
            let seconds = sec - (years * 31536000) - (months * 2592000) - (days * 86400) - (hours * 3600) - (minutes * 60); //  get seconds
            var yearsstring = (years > 1) ? `${t('years')}`:`${t('year')}`;
            var monthsstring = (months > 1) ?  `${t('months')}`:`${t('month')}`;
            var daysstring = (days > 1) ? `${t('days')}`:`${t('day')}`;
            var hoursstring = (hours > 1) ? `${t('hours')}`:`${t('hour')}`;
            var minutesstring = (minutes > 1) ? `${t('minutes')}`:`${t('minute')}`;
            var secondsstring = (seconds > 1) ? `${t('seconds')}`:`${t('second')}`;
            if ( years > 0 ) {
                return `${years} ${yearsstring} ${t('ago')}`;
            }
            if ( months > 0 ) {
                return `${months} ${monthsstring} ${t('ago')}`;
            }
            if ( days > 0 ) {
                return `${days} ${daysstring} ${t('ago')}`;
            }
            if ( hours > 0 ) {
                return `${hours} ${hoursstring} ${t('ago')}`;
            }
            if ( minutes > 0 ) {
                return `${minutes} ${minutesstring} ${t('ago')}`;
            }
            if ( seconds == 0 ) {
                return `${seconds} ${t('seconds')} ${t('ago')}`;
            }
            return `${seconds} ${secondsstring} ${t('ago')}`;
        }
    </script>
    <script>
        async function checkHeartbeat() {
            if ( !relayParam && !stage_3_relays.includes( relay ) && stage_3_relays.length > 0 ) {
                var note = await getNote( relay, "25e5c82273a271cb1a840d0060391a0bf4965cafeb029d5ab55350b418953fbb" );
                if ( note == "none" ) {
                    var rando = Math.floor( Math.random() * stage_3_relays.length );
                    relay = stage_3_relays[ rando ];
                    socket.removeEventListener( 'open', openConnection );
                    socket.removeEventListener( 'message', handleMessage );
                    socket = new WebSocket( relay );
                    socket.addEventListener( 'message', handleMessage );
                    socket.addEventListener( 'open', openConnection );
                }
            }
            heartbeat = false;
            var heartbeatsubId   = "00000002" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
            var heartbeatfilter  = { "ids": [ "41ce9bc50da77dda5542f020370ecc2b056d8f2be93c1cedf1bf57efcab095b0" ] }
            var heartbeatsub     = [ "REQ", heartbeatsubId, heartbeatfilter ];
            if ( socket && socket.readyState != 0 ) {
                socket.send( JSON.stringify( heartbeatsub ) );
            }
            setTimeout( function() {
                var closer = [ "CLOSE", heartbeatsubId ];
                if ( socket && socket.readyState != 0 ) {
                    socket.send( JSON.stringify( closer ) );
                }
            }, 1500 );
            setTimeout( function() {
                if ( !heartbeat && socket.readyState == 3 ) {
                    socket.removeEventListener( 'open', openConnection );
                    socket.removeEventListener( 'message', handleMessage );
                    socket = new WebSocket( relay );
                    socket.addEventListener( 'message', handleMessage );
                    socket.addEventListener( 'open', openConnection );
                }
            }, 2000 );
        }
    </script>
    <script>
        function modDMMeta() {
            var i; for ( i=0; i<document.getElementsByClassName( "dm-outer" ).length; i++ ) {
                var pubkey = document.getElementsByClassName( "dm-outer" )[ i ].getAttribute( "data-pubkey" );
                getUserMeta( pubkey );
            }
        }
    </script>
    <script>
        function msgContext( id, pubkey, replyingTo, content ) {
            if( isTextSelected() ) return;
            otherKey = replyingTo;
            content = DOMPurify.sanitize( content );
            var shortened_content = content.replace( /\n/g, " " ).substring( 0, 50 );
            if ( content.length > 50 ) {
                shortened_content = shortened_content + "...";
            }
            shortened_content_for_code = buffer.Buffer.from( shortened_content ).toString( "hex" );
            shortened_content_for_display = shortened_content;
            document.getElementById( "modal" ).innerHTML = "";
            document.getElementById( "modal" ).innerHTML += `<div><strong>Message</strong></div>`;
            document.getElementById( "modal" ).innerHTML += shortened_content_for_display;
            document.getElementById( "modal" ).innerHTML += `<hr style="border: 1px solid; margin-top: 20px;" />`;
            document.getElementById( "modal" ).innerHTML += `<div class="msg-context-option"><button class="msg-context-btn" onclick="replyToMsg( '${id}', '${shortened_content_for_code}', '${pubkey}' )">${t('replyToThisMessage')}</button></div>`;
            //document.getElementById( "modal" ).innerHTML += `<div class="msg-context-option"><button class="msg-context-btn" onclick="atAUser( '${event.pubkey}' )">@ this user</button></div>`;
            document.getElementById( "modal" ).innerHTML += `<div class="msg-context-option"><button class="msg-context-btn" onclick="window.open( 'https://nostr.guru/e/${id}', '_blank' )">${t('viewThisEvent')}</button></div>`;
            document.getElementById( "modal" ).innerHTML += `<div class="msg-context-option"><button class="msg-context-btn" onclick="blockPubkey( '${otherKey}' )", '_blank' )">${t('blockThisUser')}</button></div>`;
            document.getElementById( "black-bg" ).style.display = "block";
            document.getElementById( "modal" ).style.display = "block";
            document.getElementById( "modal" ).style.textAlign = "left";
        }
    </script>
    <script>
        function blockPubkey( pubkey ) {
            var conf = confirm( `${t('confirmUserBlock')}` );
            if ( !conf ) return;
            if ( localStorage[ "local_pubkey_blacklist" ] ) {
                var local_pubkey_blacklist = JSON.parse( localStorage[ "local_pubkey_blacklist" ] );
            } else {
                var local_pubkey_blacklist = [];
            }
            local_pubkey_blacklist.push( otherKey );
            localStorage[ "local_pubkey_blacklist" ] = JSON.stringify( local_pubkey_blacklist );
            document.querySelectorAll( `div[ data-author="${pubkey}"]` ).forEach( function( msg ) {
                msg.style.display = "none";
            });
            document.getElementById( "black-bg" ).style.display = "none";
            document.getElementById( "modal" ).style.display = "none";
            document.getElementsByClassName( "note-input" )[ 0 ].focus();
            document.getElementsByClassName( "note-input" )[ 0 ].select();
        }
    </script>
    <script>
        function replyToMsg( id, content, pubkey ) {
            content = buffer.Buffer.from( content, "hex" ).toString();
            document.getElementById( "black-bg" ).style.display = "none";
            document.getElementById( "modal" ).style.display = "none";
            document.getElementsByClassName( "reply-div" )[ 0 ].innerHTML = `<span class="reply-x" onclick="removeReply();">&times; </span>`;
            document.getElementsByClassName( "reply-div" )[ 0 ].innerHTML += content;
            document.getElementsByClassName( "reply-div" )[ 0 ].setAttribute( "data-event-id", id );
            document.getElementsByClassName( "reply-div" )[ 0 ].setAttribute( "data-pubkey", pubkey );
            document.getElementsByClassName( "reply-div" )[ 0 ].style.display = "block";
            if ( !document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" ) && !document.getElementsByClassName( "active" )[ 0 ].classList.contains( "manage-channels-outer" ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendPublic );
                document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendPublic );
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPublicWithReply );
                document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPublicWithReply );
            } else if ( !document.getElementsByClassName( "active" )[ 0 ].classList.contains( "manage-channels-outer" ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendPrivate );
                document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendPrivate );
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPrivateWithReply );
                document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPrivateWithReply );
            } else if ( document.getElementsByClassName( "active" )[ 0 ].classList.contains( "manage-channels-outer" ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendGlobal );
                document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendGlobal );
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendGlobalWithReply );
                document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendGlobalWithReply );
            }
            document.getElementsByClassName( "note-input" )[ 0 ].focus();
            document.getElementsByClassName( "note-input" )[ 0 ].select();
        }
    </script>
    <script>
        function removeReply( id, content, pubkey ) {
            document.getElementsByClassName( "reply-div" )[ 0 ].style.display = "none";
            document.getElementsByClassName( "reply-div" )[ 0 ].innerHTML = '';
            if ( document.getElementsByClassName( "active" )[ 0 ].classList.contains( "globalfeed" ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendGlobalWithReply );
                document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendGlobalWithReply );
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendGlobal );
                document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendGlobal );
            }
            if ( !document.getElementsByClassName( "active" )[ 0 ].classList.contains( "globalfeed" ) && !document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendPublicWithReply );
                document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendPublicWithReply );
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPublic );
                document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPublic );
            }
            if ( !document.getElementsByClassName( "active" )[ 0 ].classList.contains( "globalfeed" ) && document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" ) ) {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.removeEventListener( 'keypress', enterSendPrivateWithReply );
                document.getElementsByClassName( "send-btn" )[ 0 ].removeEventListener( 'click', clickSendPrivateWithReply );
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPrivate );
                document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPrivate );
            }
        }
    </script>
    <script>
        function atAUser( pubkey ) {
            console.log( pubkey );
            document.getElementById( "black-bg" ).style.display = "none";
            document.getElementById( "modal" ).style.display = "none";
        }
    </script>
    <script>
        function doBackgroundTasks() {
            array_of_pubkeys.forEach( function() {
                getUserMeta( array_of_pubkeys[ 0 ] );
                array_of_pubkeys.shift();
            });
            checkHeartbeat();
            setOffset();
            getBalance();
            var i; for ( i=0; i<document.getElementsByClassName( "time" ).length; i++ ) {
                var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
                var event_time = document.getElementsByClassName( "time" )[ i ].getAttribute( "data-timestamp" )
                var how_long_ago = convertHMS( now - event_time )
                document.getElementsByClassName( "time" )[ i ].innerText = how_long_ago;
            }
            setTimeout( function() {doBackgroundTasks();}, 10000 );
            modDMMeta();
            Object.keys( imagemap ).forEach( function( pubkey ) {
                if ( pubkey in imagemap && imagemap[ pubkey ] != "none" ) {
                    var i; for ( i=0; i<document.getElementsByClassName( pubkey ).length; i++ ) {
                        if ( !document.getElementsByClassName( pubkey )[ i ].classList.contains( "removable-channel" ) && document.getElementsByClassName( pubkey )[ i ] && document.getElementsByClassName( pubkey )[ i ].parentElement && document.getElementsByClassName( pubkey )[ i ].parentElement.parentElement && document.getElementsByClassName( pubkey )[ i ].parentElement.parentElement.getElementsByClassName( "picture" )[ 0 ] ) {
                            document.getElementsByClassName( pubkey )[ i ].parentElement.parentElement.getElementsByClassName( "picture" )[ 0 ].style.backgroundImage = "url(" + imagemap[ pubkey ] + ")";
                        }
                    }
                    var i; for ( i=0; i<document.getElementsByClassName( pubkey.substring( 0, 20 ) ).length; i++ ) {
                        document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ i ].getElementsByTagName( "span" )[ 0 ].style.backgroundImage = "url(" + imagemap[ pubkey ] + ")";
                    }
                }
            });
            Object.keys( namemap ).forEach( function( pubkey ) {
                if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                    var i; for ( i=0; i<document.getElementsByClassName( pubkey ).length; i++ ) {
                        if ( !document.getElementsByClassName( pubkey )[ i ].classList.contains( "removable-channel" ) ) {
                            document.getElementsByClassName( pubkey )[ i ].innerText = namemap[ pubkey ];
                        }
                    }
                    var i; for ( i=0; i<document.getElementsByClassName( pubkey.substring( 0, 20 ) ).length; i++ ) {
                        document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ i ].getElementsByClassName( "name" )[ 0 ].innerText = namemap[ pubkey ];
                    }
                }
            });
        }
        doBackgroundTasks();
        shutKeyboard();
    </script>
    <script>
        function manageChannels() {
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( "manage-channels-outer" )[ 0 ].classList.add( "active" );
            var channels_info = [];
            var i; for ( i=0; i<document.getElementsByClassName( "channel-outer" ).length; i++ ) {
                var obj = {}
                obj[ "id" ] = document.getElementsByClassName( "channel-outer" )[ i ].getAttribute( "data-id" );
                obj[ "img" ] = document.getElementsByClassName( "channel-outer" )[ i ].getAttribute( "data-img" );
                obj[ "name" ] = document.getElementsByClassName( "channel-outer" )[ i ].getElementsByClassName( "name" )[ 0 ].innerText;
                channels_info.push( obj );
            }
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle fa fa-list-check"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('manageChannels')}</div>
                            <div class="message">${t('manageChannelsMessage')}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                    <h2>${t('addChannel')}</h2>
                    <input class="add-channel-input" type="text" placeholder="${t('addChannelPlaceholder')}" />
                    <button class="add-channel-btn">${t('submit')}</button>
                    <h2 style="margin-top: 20px;">${t('removeChannel')}</h2>
                    <div class="removable-channels"></div>
                    <h2 style="margin-top: 20px;">${t('createChannel')}</h2>
                    <input class="create-channel-name" type="text" placeholder="${t('channelNamePlaceholder')}" />
                    <input class="create-channel-image" type="text" placeholder="${t('channelImagePlaceholder')}" />
                    <p class="image-instructions">${t('imageInstructions')}</p>
                    <button class="create-channel-btn" onclick="createChannel()">${t('submit')}</button>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            channels_info.forEach( function( item ) {
                document.getElementsByClassName( "removable-channels" )[ 0 ].innerHTML += `
                        <div class="removable-channel ${item.id}">
                            <span class="x-circle" onclick="removeChannel( '${item.id}' )">&times;</span>
                            <span class="img-circle" style="background-image: url('${item.img}')"></span>
                            <span class="removable-channel-name">${item.name}</span>
                            <div style="clear: both"></div>
                        </div>
                `;
            })
            Object.keys(dms_info).forEach( function( item ) {
                document.getElementsByClassName( "removable-channels" )[ 0 ].innerHTML += `
                        <div class="removable-channel ${item}">
                            <span class="x-circle" onclick="removeDm( '${item}' )">&times;</span>
                            <span class="img-circle" style="background-image: url('${dms_info[ item ][ "picture" ]}')"></span>
                            <span class="removable-channel-name">${dms_info[ item ][ "name" ]}</span>
                            <div style="clear: both"></div>
                        </div>
                `;
            })
            document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle fa fa-list-check"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('manageChannels')}</div>
                            <div class="message">${t('manageChannelsMessage')}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "add-channel-btn" )[ 0 ].addEventListener( 'click', function ( e ) {
                var channel_id = document.getElementsByClassName( "add-channel-input" )[ 0 ].value;
                if ( channel_id && channel_id != "" ) {addChannel( channel_id );}
            });
            document.getElementsByClassName( "add-channel-input" )[ 0 ].addEventListener( 'keypress', function ( e ) {
                if ( e.key === 'Enter' ) {
                    var channel_id = document.getElementsByClassName( "add-channel-input" )[ 0 ].value;
                    if ( channel_id && channel_id != "" ) {addChannel( channel_id );}
                }
            });
        }
    </script>
    <script>
        function manageWallet( amount ) {
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].classList.add( "active" );
            document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getElementsByClassName( "notification" )[ 0 ].style.display = "none";
            document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText = "0";
            if ( document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getAttribute( "data-current-balance" ) && document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getAttribute( "data-current-balance" ) != null ) {
                localStorage[ "wallet_balance" ] = String( document.getElementsByClassName( "manage-wallet-outer" )[ 0 ].getAttribute( "data-current-balance" ) );
            }
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle fa fa-wallet"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('manageWallet')}</div>
                            <div class="message">${amount}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                    <iframe src="${wallet_url}" width="100%" height="100%" allow="clipboard-read; clipboard-write"></iframe>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            document.getElementsByClassName( "message-content" )[ 0 ].style.padding = "0px";
            document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            document.getElementsByClassName( "message-content" )[ 0 ].style.textAlign = "center";
            document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            document.getElementsByClassName( "message-content" )[ 0 ].style.overflowY = "hidden";
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle fa fa-wallet"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('manageWallet')}</div>
                            <div class="message">${amount}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
        }
    </script>
    <script>
        async function showSettings() {
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            if ( namemap[ pubKey ] && namemap[ pubKey ] != "none" ) {
                var name = namemap[ pubKey ];
            }
            if ( imagemap[ pubKey ] && imagemap[ pubKey ] != "none" ) {
                var picture = imagemap[ pubKey ];
            }
            var name = "";
            var about = "";
            var picture = "";
            if ( localStorage[ "my-meta-info" ] ) {
                var myMetaInfo = JSON.parse( localStorage[ "my-meta-info" ] );
                if ( myMetaInfo[ "name" ] && myMetaInfo[ "name" ] != "" ) {
                    name = myMetaInfo[ "name" ];
                }
                if ( myMetaInfo[ "about" ] && myMetaInfo[ "about" ] != "" ) {
                    about = myMetaInfo[ "about" ];
                }
                if ( myMetaInfo[ "picture" ] && myMetaInfo[ "picture" ] != "" ) {
                    picture = myMetaInfo[ "picture" ];
                }
            }
            var picture_to_show = picture;
            //var autoavatar = "https://hashvatar.vercel.app/" + event.pubkey;
            var autoavatar = "https://www.gravatar.com/avatar/" + pubKey + "?s=128&d=retro";
            if ( !picture_to_show || picture_to_show == "" ) {
                picture_to_show = autoavatar;
            }
            var mypriv = privKey;
            if ( mypriv ) {
                mypriv = privkeyToNsec( mypriv );
            }
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle fa fa-sliders"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('settings')}</div>
                            <div class="message">${t('modifyAllThings')}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                    <h2>${t('yourInfo')}</h2>
                    <img class="big-picture" src="${picture_to_show}" />
                    <input class="display-name" type="text" placeholder="${t('yourInfoNamePlaceholder')}" value="${name}" />
                    <textarea class="about-input" type="text" rows="5" cols="70" placeholder="${t('yourInfoAboutPlaceholder')}">${about}</textarea>
                    <input class="user-picture" type="text" placeholder="${t('yourInfoImagePlaceholder')}" value="${picture}" />
                    <p class="image-instructions">${t('imageInstructions')}</p>
                    <button class="submit-user-info" onclick='submitUserInfo();showToast( "${t('yourInfoProcessed')}" );'>${t('submit')}</button>
                    <h2 style="margin-top: 20px;">${t('publicKey')}</h2>
                    <input class="public-key" type="text" value="${pubkeyToNpub( pubKey )}" disabled />
                    <button class="copy-pubkey-btn">${t('copy')}</button>
                    <button class="convert-pubkey-btn">${t('convert')}</button>
                    <h2 style="margin-top: 20px;">${t('privateKey')}</h2>
                    <input class="private-key" type="text" value="${mypriv}" disabled />
                    <button class="copy-privkey-btn">${t('copy')}</button>
                    <button class="convert-privkey-btn">${t('convert')}</button>
                    <h2 style="margin-top: 20px;">${t('importAccount')}</h2>
                    <input class="import-privkey-input" type="text" placeholder="${t('pastePrivateKey')}" />
                    <button class="import-privkey-btn">${t('import')}</button>
                    <hr style="border: 1px solid; margin-top: 20px;" />
                    <h2 style="margin-top: 20px;">${t('walletUrl')}</h2>
                    <input class="wallet-url" type="text" value="${wallet_url}" disabled />
                    <button class="copy-walleturl-btn">${t('copy')}</button>
                    <h2 style="margin-top: 20px; display: none;">${t('adminKey')}</h2>
                    <input style="display: none;" class="admin-key" type="text" value="${adminkey}" disabled />
                    <button style="display: none;" class="copy-adminkey-btn">${t('copy')}</button>
                    <h2 style="margin-top: 20px; display: none;">${t('readKey')}</h2>
                    <input style="display: none;" class="read-key" type="text" value="${readkey}" disabled />
                    <button style="display: none;" class="copy-readkey-btn">${t('copy')}</button>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle fa fa-sliders"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('settings')}</div>
                            <div class="message">${t('modifyAllThings')}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "copy-pubkey-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "public-key" )[ 0 ] );
            });
            document.getElementsByClassName( "convert-pubkey-btn" )[ 0 ].addEventListener( "click", function() {
                if ( isBech32( document.querySelector( ".public-key" ).value ) ) {
                    document.querySelector( ".public-key" ).value = pubkeyFromNpub( document.querySelector( ".public-key" ).value );
                } else {
                    document.querySelector( ".public-key" ).value = pubkeyToNpub( document.querySelector( ".public-key" ).value );
                }
            });
            document.getElementsByClassName( "copy-privkey-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "private-key" )[ 0 ] );
            });
            document.getElementsByClassName( "convert-privkey-btn" )[ 0 ].addEventListener( "click", function() {
                if ( isBech32( document.querySelector( ".private-key" ).value ) ) {
                    document.querySelector( ".private-key" ).value = privkeyFromNsec( document.querySelector( ".private-key" ).value );
                } else {
                    document.querySelector( ".private-key" ).value = privkeyToNsec( document.querySelector( ".private-key" ).value );
                }
            });
            document.getElementsByClassName( "copy-walleturl-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "wallet-url" )[ 0 ] );
            });
            document.getElementsByClassName( "copy-adminkey-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "admin-key" )[ 0 ] );
            });
            document.getElementsByClassName( "copy-readkey-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "read-key" )[ 0 ] );
            });
            document.getElementsByClassName( "import-privkey-btn" )[ 0 ].addEventListener( "click", function() {
                importPrivkey( document.getElementsByClassName( "import-privkey-input" )[ 0 ].value );
                if ( sessionStorage[ "encrypted-open-dms" ] ) {
                    var closerid = sessionStorage[ "encrypted-open-dms" ];
                    var closer = [ "CLOSE", closerid ];
                }
                var openSubId   = "encrypted-open-dms" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
                sessionStorage[ "encrypted-open-dms" ] = openSubId;
                var openFilter  = {
                    "kinds": [ 4 ],
                    "#p": [ pubKey ],
                    "limit": 200
                }
                var openSubscription = [ "REQ", openSubId, openFilter ]
                var sendable = JSON.stringify( openSubscription )
                socket.send( sendable );
            });
        }
    </script>
    <script>
        async function showGlobal() {
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( "globalfeed" )[ 0 ].classList.add( "active" );
            document.querySelector( ".globalfeed" ).getElementsByClassName( "notification" )[ 0 ].style.display = "none";
            document.querySelector( ".globalfeed" ).getElementsByClassName( "notification" )[ 0 ].innerText = "0";
            document.querySelector( ".globalfeed" ).setAttribute( "data-num-of-new-messages", "0" );
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle fa fa-globe"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('global')}</div>
                            <div class="time"></div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                </div>
                <div class="message-form">
                    <div class="reply-div"></div>
                    <ul>
                        <li class="emoji-btn" onclick="showEmojis( 0 )">
                            <a>
                                <i class="fa fa-laugh"></i>
                            </a>
                        </li>
                        <li class="input">
                            <textarea class="note-input" rows="1" cols="70" type="text" placeholder="${t('saySomething')}" onfocus='setTimeout( function() {if ( window.innerWidth < 601 && ( window.innerHeight < Number( sessionStorage[ "full-window-height" ] ) * 0.9 ) ) {sessionStorage[ "keyboard_is_open" ] = String( 1 );var size_difference = Number( sessionStorage[ "full-window-height" ] ) - window.innerHeight;if ( !sessionStorage[ "keyboard_size" ] ) {sessionStorage[ "keyboard_size" ] = String( size_difference );}var current_height = document.getElementsByClassName( "message-content" )[ 0 ].scrollTop;var new_height = current_height + size_difference + 50;var max_height = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;if ( new_height > max_height ) {new_height = max_height;} document.getElementsByClassName( "message-content" )[ 0 ].scrollTo({top: new_height, left: 0, behavior: "smooth"});}}, 600 );'></textarea>
                        </li>
                        <li class="send-btn">
                            <a>
                                <i class="fa fa-paper-plane"></i>
                            </a>
                        </li>
                        <li class="sound-btn">
                            <a>
                                <i class="fa fa-microphone"></i>
                            </a>
                        </li>
                        <li class="image-btn">
                            <a>
                                <i class="fa fa-image"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            //document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            //document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle fa fa-globe"></span>
                        <div class="channel-wrapper">
                            <div class="name">${t('global')}</div>
                            <div data-timestamp="" class="time">loading...</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            } else {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "block";
                document.getElementsByClassName( "content" )[ 0 ].scrollTop = document.getElementsByClassName( "content" )[ 0 ].scrollHeight;
                if ( document.getElementsByClassName( "bubbletime" ).length > 0 ) {
                    document.getElementsByClassName( "bubbletime" )[ document.getElementsByClassName( "bubbletime" ).length - 1 ].scrollIntoView();
                }
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendGlobal );
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendGlobal );
            document.getElementsByClassName( "sound-btn" )[ 0 ].addEventListener( "click", function() {showToast( `${t('comingSoon')}` );});
            document.getElementsByClassName( "image-btn" )[ 0 ].addEventListener( "click", function() {
                showImgs();
            });
            addMessages( "globalfeed" );
        }
    </script>
    <script>
        async function showProfile( pubkey, name, picture ) {
            forceUpdateUserMeta( pubkey );
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle">P</span>
                        <div class="channel-wrapper">
                            <div class="name">${t('profile')}</div>
                            <div class="message">${t('checkSomeone')}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                    <img class="big-picture" src="${picture}" />
                    <h2 class="profile-name">${name}</h2>
                    <p class="profile-about" style="display: none;">${name} ${t('nameLives')}</p>
                    <p class="profile-lud06" style="display: none;"></p>
                    <h2 style="margin-top: 20px;" class="profile-pubkey-title">${name}'s ${t('_publicKey')}</h2>
                    <p class="profile-pubkey">${pubkeyToNpub( pubkey )}</p>
                    <button class="dm" onclick="dmThisUser( '${pubkey}', '${name}', '${picture}' )">${t('directMessage')}</button>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle">P</span>
                        <div class="channel-wrapper">
                            <div class="name">${t('profile')}</div>
                            <div class="message">${t('checkSomeone')}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
        }
    </script>
    <script>
        function dmThisUser( pubkey, name, picture ) {
            if ( !isStringUrl( picture ) ) {
                picture = `https://www.gravatar.com/avatar/${pubkey}?s=128&d=retro`;
            }
            if ( !document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ] ) {
                document.getElementsByClassName( "channels" )[ 0 ].firstElementChild.innerHTML += displayDMbox( pubkey, name, picture );
                var obj = {}
                obj[ "pubkey" ] = pubkey;
                obj[ "name" ] = name;
                obj[ "picture" ] = picture;
                dms_info[ pubkey ] = obj;
                localStorage[ "dms_info" ] = JSON.stringify( dms_info );
                msg_cache[ pubkey ] = [];
                localStorage[ "msg_cache" ] = JSON.stringify( msg_cache );
            }
            selectDM( pubkey, name, picture );
        }
    </script>
    <script>
        function displayDMbox( pubkey, name, picture, num_of_new_messages ) {
            var old_num_of_new_messages = 0;
            if ( num_of_new_messages > 0 ) {
                old_num_of_new_messages = num_of_new_messages;
            }
            if ( document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ] ) {
                old_num_of_new_messages = document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ].getAttribute( "data-num-of-new-messages" );
                old_num_of_new_messages = Number( old_num_of_new_messages );
            }
            var displayer = "";
            if ( old_num_of_new_messages > 0 ) {
                displayer = 'display: inline;'
            }
            if ( !isStringUrl( picture ) ) {
                picture = `https://www.gravatar.com/avatar/${pubkey}?s=128&d=retro`;
            }
            var html = `
                        <li class="dm-outer ${pubkey.substring( 0, 20 )}" data-pubkey="${pubkey}" data-img="${picture}" data-num-of-new-messages="${String( old_num_of_new_messages )}" onclick="selectDM( '${pubkey}', '${name}', '${picture}' );">
                            <a>
                                <span style="background-image: url('${picture}')"></span>
                                <div class="dm-inner">
                                    <div class="name">${name}</div>
                                    <div data-timestamp="" class="message"></div>
                                </div>
                                <span class="notification" style="background-color: #05e632;${displayer}">${String( old_num_of_new_messages )}</span>
                            </a>
                        </li>
            `;
            return html;
        }
    </script>
    <script>
        async function selectDM( pubkey, name, picture ) {
            sessionStorage[ pubkey + "-counter" ] = String( 0 );
            sessionStorage[ "scrolled" ] = false;
            document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "notification" )[ 0 ].style.display = "none";
            document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ].getElementsByClassName( "notification" )[ 0 ].innerText = "0";
            document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ].setAttribute( "data-num-of-new-messages", "0" );
            existing_messages = [];
            array_of_replies = [];
            var i; for ( i=0; i<document.getElementsByClassName( "active" ).length; i++ ) {
                document.getElementsByClassName( "active" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ].classList.add( "active" );
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span style="background-image: url('${picture}'); cursor: pointer;" onclick="showProfile( '${pubkey}', '${name}', '${picture}' )"></span>
                        <div class="channel-wrapper">
                            <div class="name">${name}</div>
                            <div class="time"></div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                </div>
                <div class="message-form">
                    <div class="reply-div"></div>
                    <ul>
                        <li class="emoji-btn" onclick="showEmojis( 0 )">
                            <a>
                                <i class="fa fa-laugh"></i>
                            </a>
                        </li>
                        <li class="input">
                            <textarea class="note-input" rows="1" cols="70" type="text" placeholder="${t('saySomething')}" onfocus='setTimeout( function() {if ( window.innerWidth < 601 && ( window.innerHeight < Number( sessionStorage[ "full-window-height" ] ) * 0.9 ) ) {sessionStorage[ "keyboard_is_open" ] = String( 1 );var size_difference = Number( sessionStorage[ "full-window-height" ] ) - window.innerHeight;if ( !sessionStorage[ "keyboard_size" ] ) {sessionStorage[ "keyboard_size" ] = String( size_difference );}var current_height = document.getElementsByClassName( "message-content" )[ 0 ].scrollTop;var new_height = current_height + size_difference + 50;var max_height = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;if ( new_height > max_height ) {new_height = max_height;} document.getElementsByClassName( "message-content" )[ 0 ].scrollTo({top: new_height, left: 0, behavior: "smooth"});}}, 600 );'></textarea>
                        </li>
                        <li class="send-btn">
                            <a>
                                <i class="fa fa-paper-plane"></i>
                            </a>
                        </li>
                        <li class="sound-btn">
                            <a>
                                <i class="fa fa-microphone"></i>
                            </a>
                        </li>
                        <li class="image-btn">
                            <a>
                                <i class="fa fa-image"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span style="background-image: url('${picture}'); cursor: pointer;" onclick="showProfile( '${pubkey}', '${name}', '${picture}' )"></span>
                        <div class="channel-wrapper">
                            <div class="name">${name}</div>
                            <div class="time"></div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a>
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            forceUpdateUserMeta( pubkey );
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            } else {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', enterSendPrivate );
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', clickSendPrivate );
            document.getElementsByClassName( "sound-btn" )[ 0 ].addEventListener( "click", function() {showToast( `${t('comingSoon')}` );});
            document.getElementsByClassName( "image-btn" )[ 0 ].addEventListener( "click", function() {
                showImgs();
            });
            addClosedDecryptedMessages( pubkey );
        }
    </script>
    <script>
        function enterSendPrivate( e ) {
            if ( e.key === 'Enter' && !isShiftDown() ) {
                var pubkey = document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" );
                sendEncryptedNote( document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value, pubkey );
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].focus();
                    document.getElementsByClassName( "note-input" )[ 0 ].select();
                }
            }
        }
    </script>
    <script>
        function enterSendPrivateWithReply( e ) {
            if ( e.key === 'Enter' && !isShiftDown() ) {
                var pubkey = document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" );
                var event_id = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-event-id" );
                var pubkeyOfRepliedToPost = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-pubkey" );
                sendEncryptedNoteWithReply( document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value, pubkey, event_id, pubkeyOfRepliedToPost );
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].focus();
                    document.getElementsByClassName( "note-input" )[ 0 ].select();
                }
            }
        }
    </script>
    <script>
        function clickSendPrivate( pubkey ) {
            keymap[ "Shift" ] = false;
            var pubkey = document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" );
            sendEncryptedNote( document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value, pubkey );
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
        }
    </script>
    <script>
        function clickSendPrivateWithReply( pubkey ) {
            keymap[ "Shift" ] = false;
            var pubkey = document.getElementsByClassName( "active" )[ 0 ].getAttribute( "data-pubkey" );
            var event_id = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-event-id" );
            var pubkeyOfRepliedToPost = document.getElementsByClassName( "reply-div" )[ 0 ].getAttribute( "data-pubkey" );
            sendEncryptedNoteWithReply( document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value, pubkey, event_id, pubkeyOfRepliedToPost );
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
        }
    </script>
    <script>
        function addChannel( id ) {
            document.getElementsByClassName( "add-channel-input" )[ 0 ].value = "";
            if ( document.getElementsByClassName( id )[ 0 ] ) return
            subscribed_channels.push( id );
            var newsubId   = "00000000" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
            var newfilter  = { "ids": [ id ] }
            var newsubscription = [ "REQ", newsubId, newfilter ]
            socket.send(JSON.stringify( newsubscription ));
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
            msg_cache[ id ] = [];
            localStorage[ "msg_cache" ] = JSON.stringify( msg_cache );
        }
    </script>
    <script>
        function removeChannel( id ) {
            var i; for ( i=0; i<document.getElementsByClassName( id ).length; i++ ) {
                document.getElementsByClassName( id )[ i ].remove();
                i = i - 1;
            }
            var i; for ( i=0; i<subscribed_channels.length; i++ ) {
                if ( subscribed_channels[ i ] == id ) {
                    subscribed_channels.splice( i, 1 );
                }
            }
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
            delete msg_cache[ id ];
            localStorage[ "msg_cache" ] = JSON.stringify( msg_cache );
        }
    </script>
    <script>
        function removeDm( pubkey ) {
            var i; for ( i=0; i<document.getElementsByClassName( pubkey.substring( 0, 20 ) ).length; i++ ) {
                document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ i ].remove();
                i = i - 1;
            }
            var i; for ( i=0; i<document.getElementsByClassName( pubkey ).length; i++ ) {
                document.getElementsByClassName( pubkey )[ i ].remove();
                i = i - 1;
            }
            delete dms_info[ pubkey ];
            localStorage[ "dms_info" ] = JSON.stringify( dms_info );
            delete msg_cache[ pubkey ];
            localStorage[ "msg_cache" ] = JSON.stringify( msg_cache );
        }
    </script>
    <script>
        async function createChannel() {
            var name = document.getElementsByClassName( "create-channel-name" )[ 0 ].value;
            var img = document.getElementsByClassName( "create-channel-image" )[ 0 ].value;
            if ( !name || name == "" ) {
                showToast( `${t('addFirstChannelName')}` );
                return;
            }
            if ( !img || img == "" ) {
                showToast(  `${t('addFirstChannelImage')}` );
                return;
            }
            document.getElementsByClassName( "create-channel-name" )[ 0 ].value = "";
            document.getElementsByClassName( "create-channel-image" )[ 0 ].value = "";
            var chan = {}
            chan[ "about" ] = "";
            chan[ "name" ] = name;
            chan[ "picture" ] = img;
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            var note = JSON.stringify( chan );
            var event = {
                "content"    : note,
                "created_at" : now,
                "kind"       : 40,
                "tags"       : [],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent(event, privKey);
            socket.send(JSON.stringify([ "EVENT", signedEvent ]))
            setTimeout( function() {addChannel( signedEvent.id );}, 1500 );
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        async function checkForEncryptionErrors( privkey, pubkey, content ) {
            try {
                if ( !admin && window.nostr ) {
                    var content = await window.nostr.nip04.decrypt( pubkey, content );
                } else {
                    var content = await decrypt( privkey, pubkey, content );
                }
            } catch ( e ) {  
                return true;  
            }
            return false;
        }
    </script>
    <script>
        function checkForUserMetaErrors( content ) {
            try {  
                var json = JSON.parse( content );
            } catch ( e ) {  
                return true;  
            }
            return false;
        }
    </script>
    <script>
        function checkForWalletImportErrors( wallet ) {
            try {  
                var json = JSON.parse( wallet );
                if ( !( "wallet_id" in json ) ) {
                    return true;
                }  
                if ( !( "adminkey" in json ) ) {
                    return true;
                }
                if ( !( "readkey" in json ) ) {
                    return true;
                }
                if ( !( "wallet_url" in json ) ) {
                    return true;
                }
            } catch ( e ) {  
                return true;  
            }
            return false;
        }
    </script>
    <script>
        function checkForChannelSubscriptionErrors( content ) {
            try {  
                var json = JSON.parse( content );
                if ( !( "picture" in json ) ) {
                    return true;
                }  
                if ( !( "name" in json ) ) {
                    return true;
                }
            } catch ( e ) {  
                return true;  
            }
            return false;
        }
    </script>
    <script>
        function copyText( element ) {
            element.select();
            element.setSelectionRange( 0, 99999 );
            navigator.clipboard.writeText( element.value );
            showToast( `${t('copied')}` );
        }
    </script>
    <script>
        function isHex(string) {
            var a = parseInt(string, 16)
            var padding = "000000000000";
            padding = padding + a.toString(16);
            final = padding.slice( -Math.abs( string.length ) )
            return final === string
        }
        function importPrivkey( privkey ) {
            if ( privkey.startsWith( "nsec" ) && isBech32( privkey ) ) {
                privkey = buffer.Buffer.from( bech32.bech32.fromWords( bech32.bech32.decode( privkey ).words ) ).toString( "hex" );
            }
            if ( privkey.length != 64 ) {
                showToast( `${t('mustBe32Byte')}` );
                return;
            }
            if ( !(
                isHex( privkey.substring( 0, 8 ) )
                && isHex( privkey.substring( 8, 16 ) )
                && isHex( privkey.substring( 16, 24 ) )
                && isHex( privkey.substring( 24, 32 ) )
                && isHex( privkey.substring( 32, 40 ) )
                && isHex( privkey.substring( 40, 48 ) )
                && isHex( privkey.substring( 48, 56 ) )
                && isHex( privkey.substring( 56, 64 ) )
                ) ) {
                showToast( `${t('isNotHex')}` );
                return;
            }
            var pubkey = nobleSecp256k1.getPublicKey( privkey, true );
            pubkey = pubkey.substring( 2 );
            privKey = privkey;
            pubKey = pubkey;
            document.getElementsByClassName( "public-key" )[ 0 ].value = pubKey;
            document.getElementsByClassName( "private-key" )[ 0 ].value = privKey;
            forceUpdateUserMeta( pubKey );
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
            var alterPrivKey = privKey.substring( 32 ) + privKey.substring( 0, 32 );
            alterPubKey = nobleSecp256k1.getPublicKey( alterPrivKey, true ).substring( 2 );
            i_should_create_a_new_wallet = true;
            importWalletFromNostrOrMakeOne( alterPubKey );
            showToast( `${t('successAccountImported')}` );
        }
    </script>
    <script>
        var keymap = {};
        onkeydown = onkeyup = function(e){
            e = e || event; // to deal with IE
            keymap[e.key] = e.type == 'keydown';
        }
        function isShiftDown() {
            if ( "Shift" in keymap ) {
                return keymap[ "Shift" ];
            }
            return false;
        }
    </script>
    <script>
        function isTextSelected() {
            return ( window.getSelection() && window.getSelection().toString() != '' );
        }
    </script>
    <div class="chat">
        <div class="sidebar">
            <div class="user-in-sidebar">
                <a>
                    <span class="plus-circle fa fa-user"></span>
                    <div class="user-profile-inner">
                        <!-- //var picture = "https://hashvatar.vercel.app/" + pubKey; -->
                        <div class="name"><script>document.getElementsByClassName( "user-in-sidebar" )[ 0 ].getElementsByTagName( "span" )[ 0 ].className = "";document.getElementsByClassName( "user-in-sidebar" )[ 0 ].getElementsByTagName( "span" )[ 0 ].style="background-image: url('https://www.gravatar.com/avatar/" + pubKey + "?s=128&d=retro')";document.getElementsByClassName( "user-in-sidebar" )[ 0 ].onclick = function() {showProfile( pubKey, pubKey.substring( 0, 15 ) + "...", "https://www.gravatar.com/avatar/" + pubKey + "?s=128&d=retro" );document.getElementsByClassName( "user-profile-inner" )[ 0 ].getElementsByClassName( "name" )[ 0 ].innerHTML = pubKey.substring( 0, 15 ) + "...";}</script></div>
                        <div class="message" data-i18n-key="viewYourProfil"></div>
                    </div>
                </a>
            </div>
            <div class="channels">
                <ul>
                    <li class="search-outer">
                        <div class="search">
                            <input type="text" placeholder="Search...">
                            <i class="fa fa-search" onclick='showToast( `${t("comingSoon")}` );document.getElementsByClassName( "search" )[ 0 ].getElementsByTagName( "input" )[ 0 ].value = "";'></i>
                        </div>
                    </li>
                    <li class="manage-wallet-outer" onclick='manageWallet( this.getElementsByClassName( "message" )[ 0 ].innerText );'>
                        <a>
                            <span class="plus-circle fa fa-wallet"></span>
                            <div class="manage-channels-inner">
                                <div class="name" data-i18n-key="manageWallet"></div>
                                <div class="message" data-i18n-key="loading"></div>
                            </div>
                            <span class="notification" style="background-color: #05e632;">200+</span>
                        </a>
                    </li>
                    <li class="manage-channels-outer" onclick="manageChannels();">
                        <a>
                            <span class="plus-circle fa fa-list-check"></span>
                            <div class="manage-channels-inner">
                                <div class="name" data-i18n-key="manageChannels"></div>
                                <div class="message" data-i18n-key="manageChannelsMessage"></div>
                            </div>
                        </a>
                    </li>
                    <li class="manage-channels-outer globalfeed" onclick="showGlobal();">
                        <a>
                            <span class="plus-circle fa fa-globe"></span>
                            <div class="manage-channels-inner">
                                <div class="name" data-i18n-key="global"></div>
                                <div class="message" data-i18n-key="globalDesc"></div>
                            </div>
                            <span class="notification" style="display: none;">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="content">
            <div class="message-header">
                <div class="channel-info">
                    <span style="background-image: url('./anigma-logo.png')"></span>
                    <div class="channel-wrapper">
                        <div class="name" data-i18n-key="NAME"></div>
                        <div class="message" data-i18n-key="DESC"></div>
                    </div>
                </div>
                <div class="actions">
                    <ul>
                        <li>
                            <div>
                                <select class="locale-switcher" onchange="setLocale(value)">
                                    <option value="en" class="optionChild">English</option>
                                    <option value="de" class="optionChild">Deutsch</option>
                                </select>
                            </div>
                        </li>
                        <li class="hotdog">
                            <a>
                                <i class="fa fa-ellipsis-v"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="message-content">
                <div class="startup-message" data-i18n-key="startPageText"></div>
            </div>
        </div>
    </div>
    <div class="message-header-hinder">
    </div>
    <div class="message-header-alt">
    </div>
    <div id="vidDiv">
        <div id="vidDivheader">
            <a class="mover">
                <i class="fa fa-arrows"></i>
            </a>
            <a class="xer" onclick='document.getElementsByClassName( "inner-vid" )[ 0 ].innerHTML = "";document.getElementById( "vidDiv" ).style.display = "none";'>
                <i class="fa fa-xmark"></i>
            </a>
            <a class="minmax" onclick='if ( document.getElementsByClassName( "inner-vid" )[ 0 ].getElementsByClassName( "ratio" )[ 0 ].offsetWidth > 200 ) {document.getElementsByClassName( "inner-vid" )[ 0 ].getElementsByClassName( "ratio" )[ 0 ].style.maxWidth = "190px";} else {document.getElementsByClassName( "inner-vid" )[ 0 ].getElementsByClassName( "ratio" )[ 0 ].style.maxWidth = "500px";}'>
                <i class="fa fa-window-maximize"></i>
            </a>
        </div>
        <div class="inner-vid"></div>
    </div>
    <script>
        function joinChannelOnStart() {
            if ( channelParam && !profileParam && document.getElementsByClassName( "channels" )[ 0 ] && document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( channelParam )[ 0 ] ) {
                var channel = document.getElementsByClassName( "channels" )[ 0 ].getElementsByClassName( channelParam )[ 0 ];
                selectChannel( channel );
            }
            if ( profileParam ) {
                showProfile( profileParam, profileParam.substring( 0, 15 ) + "...", `https://www.gravatar.com/avatar/${profileParam}?s=128&d=retro` )
            }
            var channelIsSelected = document.querySelectorAll( ".active" ).length > 0;
            var profileIsSelected = document.querySelector( ".channel-wrapper" ).querySelector( ".name" ).innerText == "Profile";
            if ( !( channelIsSelected || profileIsSelected ) && ( channelParam || profileParam ) ) {
                setTimeout( function() {joinChannelOnStart();}, 100 );
            }
        }
        joinChannelOnStart();
    </script>
    <script>
        document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
            showSettings();
        });
        setTimeout( function() {
            document.getElementsByClassName( "search" )[ 0 ].getElementsByTagName( "input" )[ 0 ].addEventListener( 'keypress', function ( e ) {
                if ( e.key === 'Enter' ) {
                    showToast( `${t("comingSoon")}` );
                    document.getElementsByClassName( "search" )[ 0 ].getElementsByTagName( "input" )[ 0 ].value = "";
                }
            });
        }, 3000 );
    </script>
    <script>
        function setNoteInputHeight() {
            setTimeout( function() {setNoteInputHeight();}, 50 );
            if ( !document.getElementsByClassName( "note-input" )[ 0 ] ) return
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
            var text = document.getElementsByClassName( "note-input" )[ 0 ].value;
            var match = /\r|\n/.exec(text);
            if ( match || document.getElementsByClassName( "note-input" )[ 0 ].offsetHeight >= 40 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].style.lineHeight = "18px";
                document.getElementsByClassName( "note-input" )[ 0 ].style.borderRadius = "10px";
            } else if ( document.getElementsByClassName( "note-input" )[ 0 ].offsetHeight < 34 ) {
                document.getElementsByClassName( "note-input" )[ 0 ].style.lineHeight = "35px";
                document.getElementsByClassName( "note-input" )[ 0 ].style.borderRadius = "36px";
            }
            if ( window.innerWidth < 601 && document.getElementsByClassName( "note-input" )[ 0 ] && document.getElementsByClassName( "note-input" )[ 0 ].value && document.getElementsByClassName( "note-input" )[ 0 ].value != "" ) {
                document.getElementsByClassName( "sound-btn" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "image-btn" )[ 0 ].style.display = "none";
            } else {
                if ( document.getElementsByClassName( "sound-btn" )[ 0 ] && document.getElementsByClassName( "image-btn" )[ 0 ] ) {
                    document.getElementsByClassName( "sound-btn" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "image-btn" )[ 0 ].style.display = "block";
                }
            }
        }
        setNoteInputHeight();
    </script>
    <script>
        function getUserMeta( pubkey ) {
            if ( pubkey in imagemap && imagemap[ pubkey ] != "none" ) {
                var i; for ( i=0; i<document.getElementsByClassName( pubkey ).length; i++ ) {
                    if ( !document.getElementsByClassName( pubkey )[ i ].classList.contains( "removable-channel" ) && document.getElementsByClassName( pubkey )[ i ].parentElement && document.getElementsByClassName( pubkey )[ i ].parentElement.parentElement && document.getElementsByClassName( pubkey )[ i ].parentElement.parentElement.getElementsByClassName( "picture" )[ 0 ] ) {
                        document.getElementsByClassName( pubkey )[ i ].parentElement.parentElement.getElementsByClassName( "picture" )[ 0 ].style.backgroundImage = "url(" + DOMPurify.sanitize( imagemap[ pubkey ] ) + ")";
                    }
                }
                var i; for ( i=0; i<document.getElementsByClassName( pubkey.substring( 0, 20 ) ).length; i++ ) {
                    document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ i ].getElementsByTagName( "span" )[ 0 ].style.backgroundImage = "url(" + DOMPurify.sanitize( imagemap[ pubkey ] ) + ")";
                }
            } else if ( !( pubkey in imagemap ) ) {
                var newsubId   = "00000001" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
                var newfilter  = { "authors": [ pubkey ], "kinds": [0], "limit": 1 }
                var newsubmo = [ "REQ", newsubId, newfilter ]
                socket.send(JSON.stringify( newsubmo ));
                setTimeout( function() {
                    var closer = [ "CLOSE", newsubId ];
                    socket.send(JSON.stringify( closer ));
                }, 1500 );
            }
            if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                var i; for ( i=0; i<document.getElementsByClassName( pubkey ).length; i++ ) {
                    if ( !document.getElementsByClassName( pubkey )[ i ].classList.contains( "removable-channel" ) ) {
                        document.getElementsByClassName( pubkey )[ i ].innerText = DOMPurify.sanitize( namemap[ pubkey ] );
                    }
                }
                var i; for ( i=0; i<document.getElementsByClassName( pubkey.substring( 0, 20 ) ).length; i++ ) {
                    document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ i ].getElementsByClassName( "name" )[ 0 ].innerText = DOMPurify.sanitize( namemap[ pubkey ] );
                }
            } else if ( !( pubkey in namemap ) ) {
                var newsubId   = "00000001" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
                var newfilter  = { "authors": [ pubkey ], "kinds": [0], "limit": 1 }
                var newsubmo = [ "REQ", newsubId, newfilter ]
                socket.send(JSON.stringify( newsubmo ));
                setTimeout( function() {
                    var closer = [ "CLOSE", newsubId ];
                    socket.send(JSON.stringify( closer ));
                }, 1500 );
            }
        }
    </script>
    <script>
        function addPubkeyToSidebar( pubkey ) {
            //check if pubkey is mapped to image
            if ( pubkey in imagemap && imagemap[ pubkey ] != "none" ) {
                var picture = DOMPurify.sanitize( imagemap[ pubkey ] );
            } else {
                //var picture = "https://hashvatar.vercel.app/" + event.pubkey;
                var picture = "https://www.gravatar.com/avatar/" + pubkey + "?s=128&d=retro";
            }
            //check if pubkey is mapped to name
            if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                var name = DOMPurify.sanitize( namemap[ pubkey ] );
            } else {
                var name = pubkeyToNpub( pubkey ).substring( 0, 15 ) + "...";
            }
            var obj = {}
            obj[ "pubkey" ] = pubkey;
            obj[ "name" ] = name;
            obj[ "picture" ] = picture;
            dms_info[ pubkey ] = obj;
            localStorage[ "dms_info" ] = JSON.stringify( dms_info );
            getUserMeta( pubkey );
            setTimeout( function() {
                if ( !document.getElementsByClassName( pubkey.substring( 0, 20 ) )[ 0 ] ) {
                    document.getElementsByClassName( "channels" )[ 0 ].firstElementChild.innerHTML += displayDMbox( pubkey, name, picture, 1 );
                }
            }, 1000 );
        }
    </script>
    <script>
        async function submitUserInfo() {
            var name = "";
            var about = "";
            var img = "";
            if ( localStorage[ "my-meta-info" ] ) {
                var myMetaInfo = JSON.parse( localStorage[ "my-meta-info" ] );
            } else {
                var myMetaInfo = {}
            }
            if ( document.getElementsByClassName( "display-name" )[ 0 ] ) {
                name = document.getElementsByClassName( "display-name" )[ 0 ].value;
            } else if ( myMetaInfo[ "name" ] ) {
                name = myMetaInfo[ "name" ];
            }
            if ( document.getElementsByClassName( "about-input" )[ 0 ] ) {
                about = document.getElementsByClassName( "about-input" )[ 0 ].value;
            } else if ( myMetaInfo[ "about" ] ) {
                about = myMetaInfo[ "about" ];
            }
            if ( document.getElementsByClassName( "user-picture" )[ 0 ] ) {
                img = document.getElementsByClassName( "user-picture" )[ 0 ].value;
            } else if ( myMetaInfo[ "picture" ] ) {
                img = myMetaInfo[ "picture" ];
            }
            if ( name && name != "" ) {
                myMetaInfo[ "name" ] = name;
            }
            if ( about && about != "" ) {
                myMetaInfo[ "about" ] = about;
            }
            if ( img && img != "" ) {
                myMetaInfo[ "picture" ] = img;
            }
            myMetaInfo[ "lud06" ] = lud06;
            localStorage[ "my-meta-info" ] = JSON.stringify( myMetaInfo );
            var note = JSON.stringify( myMetaInfo );
            var now = Math.floor( Date.now() / 1000 ) + Number( sessionStorage[ "time-offset" ] );
            var event = {
                "content"    : note,
                "created_at" : now,
                "kind"       : 0,
                "tags"       : [],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent(event, privKey);
            socket.send(JSON.stringify([ "EVENT", signedEvent ]));
            setTimeout( function() {forceUpdateUserMeta( pubKey );}, 1500 );
            //duplicate to other relays
            var i; for ( i=0; i<stage_3_relays.length; i++ ) {
                var dup_id = await dupNote( stage_3_relays[ i ], JSON.stringify( [ "EVENT", signedEvent ] ) );
                var timeout = await waitSomeSeconds( 2 );
            }
        }
    </script>
    <script>
        function addMessageToCache( pubkey, id, event_time, parent, color, name, picture, content, replyingTo ) {
            name = DOMPurify.sanitize( name );
            picture = DOMPurify.sanitize( picture );
            content = DOMPurify.sanitize( content );
            if ( !msg_cache[ parent ] ) {
                msg_cache[ parent ] = [];
            }
            if ( msg_cache[ parent ].some( function( e ) {if ( Object.keys( e )[ 0 ] == id ) return e } ) ) return
            var lower_obj = {}
            var higher_obj = {}
            if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                name = namemap[ pubkey ];
            }
            if ( pubkey in imagemap && imagemap[ pubkey ] != "none" ) {
                picture = imagemap[ pubkey ];
            }
            lower_obj[ "pubkey" ] = pubkey;
            lower_obj[ "id" ] = id;
            lower_obj[ "event_time" ] = event_time;
            lower_obj[ "parent" ] = parent;
            lower_obj[ "color" ] = color;
            lower_obj[ "name" ] = name;
            lower_obj[ "picture" ] = picture;
            lower_obj[ "content" ] = content;
            lower_obj[ "replyingTo" ] = replyingTo;
            higher_obj[ id ] = lower_obj;
            if ( msg_cache[ parent ].length > 199 ) {
                msg_cache[ parent ].pop();
            }
            msg_cache[ parent ].push( higher_obj );
            msg_cache[ parent ].sort(
                function( a, b ) {
                    return b[ Object.keys( b )[ 0 ] ][ "event_time"] - a[ Object.keys( a )[ 0 ] ][ "event_time" ];
                }
            )
            localStorage[ "msg_cache" ] = JSON.stringify( msg_cache );
        }
    </script>
    <script>
        function showToast( content ) {
            var x = document.getElementById( "toast" );
            x.innerHTML = content;
            x.className = "show";
            setTimeout(function(){ x.classList.remove( "show" ); }, 3000);
        }
    </script>
    <div style="position: absolute; top: 0px; background-color: black; color: white; width: 100%; height: 2rem; display: flex; justify-content: center; align-items: center;"><div>Anigma is not secure yet. Do not use a private key you are not okay with leaking.</div></div>
    <div id="toast"></div>
    <div id="black-bg" onclick="modalVanish();"></div>
    <div id="modal"></div>
    <script>
        function showEmojis( start ) {
            var emojis = ["\u{1F600}","\u{1F603}","\u{1F604}","\u{1F601}","\u{1F606}","\u{1F605}","\u{1F602}","\u{1F923}","\u{1F60A}","\u{1F607}","\u{1F642}","\u{1F643}","\u{1F609}","\u{1F60C}","\u{1F60D}","\u{1F970}","\u{1F618}","\u{1F617}","\u{1F619}","\u{1F61A}","\u{1F60B}","\u{1F61B}","\u{1F61D}","\u{1F61C}","\u{1F92A}","\u{1F928}","\u{1F9D0}","\u{1F913}","\u{1F60E}","\u{1F929}","\u{1F973}","\u{1F60F}","\u{1F612}","\u{1F61E}","\u{1F614}","\u{1F61F}","\u{1F615}","\u{1F641}","\u2639\uFE0F","\u{1F623}","\u{1F616}","\u{1F62B}","\u{1F629}","\u{1F97A}","\u{1F622}","\u{1F62D}","\u{1F624}","\u{1F620}","\u{1F621}","\u{1F92C}","\u{1F92F}","\u{1F633}","\u{1F975}","\u{1F976}","\u{1F631}","\u{1F628}","\u{1F630}","\u{1F625}","\u{1F613}","\u{1F917}","\u{1F914}","\u{1F92D}","\u{1F92B}","\u{1F925}","\u{1F636}","\u{1F610}","\u{1F611}","\u{1F62C}","\u{1F644}","\u{1F62F}","\u{1F626}","\u{1F627}","\u{1F62E}","\u{1F632}","\u{1F971}","\u{1F634}","\u{1F924}","\u{1F62A}","\u{1F635}","\u{1F910}","\u{1F974}","\u{1F922}","\u{1F92E}","\u{1F927}","\u{1F637}","\u{1F912}","\u{1F915}","\u{1F911}","\u{1F920}","\u{1F608}","\u{1F47F}","\u{1F479}","\u{1F47A}","\u{1F921}","\u{1F4A9}","\u{1F47B}","\u{1F480}","\u2620\uFE0F","\u{1F47D}","\u{1F47E}","\u{1F916}","\u{1F383}","\u{1F63A}","\u{1F638}","\u{1F639}","\u{1F63B}","\u{1F63C}","\u{1F63D}","\u{1F640}","\u{1F63F}","\u{1F63E}","\u{1F44B}","\u{1F91A}","\u{1F590}","\u270B","\u{1F596}","\u{1F44C}","\u{1F90F}","\u270C\uFE0F","\u{1F91E}","\u{1F91F}","\u{1F918}","\u{1F919}","\u{1F448}","\u{1F449}","\u{1F446}","\u{1F595}","\u{1F447}","\u261D\uFE0F","\u{1F44D}","\u{1F44E}","\u270A","\u{1F44A}","\u{1F91B}","\u{1F91C}","\u{1F44F}","\u{1F64C}","\u{1F450}","\u{1F932}","\u{1F91D}","\u{1F64F}","\u270D\uFE0F","\u{1F485}","\u{1F933}","\u{1F4AA}","\u{1F9BE}","\u{1F9B5}","\u{1F9BF}","\u{1F9B6}","\u{1F463}","\u{1F442}","\u{1F9BB}","\u{1F443}","\u{1F9E0}","\u{1F9B7}","\u{1F9B4}","\u{1F440}","\u{1F445}","\u{1F444}","\u{1F48B}","\u{1FA78}","\u{1F525}","\u{1F476}","\u{1F467}","\u{1F9D2}","\u{1F466}","\u{1F469}","\u{1F9D1}","\u{1F468}","\u{1F469}\u200D\u{1F9B1}","\u{1F468}\u200D\u{1F9B1}","\u{1F469}\u200D\u{1F9B0}","\u{1F468}\u200D\u{1F9B0}","\u{1F471}\u200D\u2640\uFE0F","\u{1F471}","\u{1F471}\u200D\u2642\uFE0F","\u{1F469}\u200D\u{1F9B3}","\u{1F468}\u200D\u{1F9B3}","\u{1F469}\u200D\u{1F9B2}","\u{1F468}\u200D\u{1F9B2}","\u{1F9D4}","\u{1F475}","\u{1F9D3}","\u{1F474}","\u{1F472}","\u{1F473}\u200D\u2640\uFE0F","\u{1F473}","\u{1F473}\u200D\u2642\uFE0F","\u{1F9D5}","\u{1F46E}\u200D\u2640\uFE0F","\u{1F46E}","\u{1F46E}\u200D\u2642\uFE0F","\u{1F477}\u200D\u2640\uFE0F","\u{1F477}","\u{1F477}\u200D\u2642\uFE0F","\u{1F482}\u200D\u2640\uFE0F","\u{1F482}","\u{1F482}\u200D\u2642\uFE0F","\u{1F575}\uFE0F\u200D\u2640\uFE0F","\u{1F575}\uFE0F","\u{1F575}\uFE0F\u200D\u2642\uFE0F","\u{1F469}\u200D\u2695\uFE0F","\u{1F468}\u200D\u2695\uFE0F","\u{1F469}\u200D\u{1F33E}","\u{1F468}\u200D\u{1F33E}","\u{1F469}\u200D\u{1F373}","\u{1F468}\u200D\u{1F373}","\u{1F469}\u200D\u{1F393}","\u{1F468}\u200D\u{1F393}","\u{1F469}\u200D\u{1F3A4}","\u{1F468}\u200D\u{1F3A4}","\u{1F469}\u200D\u{1F3EB}","\u{1F468}\u200D\u{1F3EB}","\u{1F469}\u200D\u{1F3ED}","\u{1F468}\u200D\u{1F3ED}","\u{1F469}\u200D\u{1F4BB}","\u{1F468}\u200D\u{1F4BB}","\u{1F469}\u200D\u{1F4BC}","\u{1F468}\u200D\u{1F4BC}","\u{1F469}\u200D\u{1F527}","\u{1F468}\u200D\u{1F527}","\u{1F469}\u200D\u{1F52C}","\u{1F468}\u200D\u{1F52C}","\u{1F469}\u200D\u{1F3A8}","\u{1F468}\u200D\u{1F3A8}","\u{1F469}\u200D\u{1F692}","\u{1F468}\u200D\u{1F692}","\u{1F469}\u200D\u2708\uFE0F","\u{1F468}\u200D\u2708\uFE0F","\u{1F469}\u200D\u{1F680}","\u{1F468}\u200D\u{1F680}","\u{1F469}\u200D\u2696\uFE0F","\u{1F468}\u200D\u2696\uFE0F","\u{1F470}","\u{1F935}","\u{1F478}","\u{1F934}","\u{1F9B8}\u200D\u2640\uFE0F","\u{1F9B8}","\u{1F9B8}\u200D\u2642\uFE0F","\u{1F9B9}\u200D\u2640\uFE0F","\u{1F9B9}","\u{1F9B9}\u200D\u2642\uFE0F","\u{1F936}","\u{1F385}","\u{1F9D9}\u200D\u2640\uFE0F","\u{1F9D9}","\u{1F9D9}\u200D\u2642\uFE0F","\u{1F9DD}\u200D\u2640\uFE0F","\u{1F9DD}","\u{1F9DD}\u200D\u2642\uFE0F","\u{1F9DB}\u200D\u2640\uFE0F","\u{1F9DB}","\u{1F9DB}\u200D\u2642\uFE0F","\u{1F9DF}\u200D\u2640\uFE0F","\u{1F9DF}","\u{1F9DF}\u200D\u2642\uFE0F","\u{1F9DE}\u200D\u2640\uFE0F","\u{1F9DE}","\u{1F9DE}\u200D\u2642\uFE0F","\u{1F9DC}\u200D\u2640\uFE0F","\u{1F9DC}","\u{1F9DC}\u200D\u2642\uFE0F","\u{1F9DA}\u200D\u2640\uFE0F","\u{1F9DA}","\u{1F9DA}\u200D\u2642\uFE0F","\u{1F47C}","\u{1F930}","\u{1F931}","\u{1F647}\u200D\u2640\uFE0F","\u{1F647}","\u{1F647}\u200D\u2642\uFE0F","\u{1F481}\u200D\u2640\uFE0F","\u{1F481}","\u{1F481}\u200D\u2642\uFE0F","\u{1F645}\u200D\u2640\uFE0F","\u{1F645}","\u{1F645}\u200D\u2642\uFE0F","\u{1F646}\u200D\u2640\uFE0F","\u{1F646}","\u{1F646}\u200D\u2642\uFE0F","\u{1F64B}\u200D\u2640\uFE0F","\u{1F64B}","\u{1F64B}\u200D\u2642\uFE0F","\u{1F9CF}\u200D\u2640\uFE0F","\u{1F9CF}","\u{1F9CF}\u200D\u2642\uFE0F","\u{1F926}\u200D\u2640\uFE0F","\u{1F926}","\u{1F926}\u200D\u2642\uFE0F","\u{1F937}\u200D\u2640\uFE0F","\u{1F937}","\u{1F937}\u200D\u2642\uFE0F","\u{1F64E}\u200D\u2640\uFE0F","\u{1F64E}","\u{1F64E}\u200D\u2642\uFE0F","\u{1F64D}\u200D\u2640\uFE0F","\u{1F64D}","\u{1F64D}\u200D\u2642\uFE0F","\u{1F487}\u200D\u2640\uFE0F","\u{1F487}","\u{1F487}\u200D\u2642\uFE0F","\u{1F486}\u200D\u2640\uFE0F","\u{1F486}","\u{1F486}\u200D\u2642\uFE0F","\u{1F9D6}\u200D\u2640\uFE0F","\u{1F9D6}","\u{1F9D6}\u200D\u2642\uFE0F","\u{1F485}","\u{1F933}","\u{1F483}","\u{1F57A}","\u{1F46F}\u200D\u2640\uFE0F","\u{1F46F}","\u{1F46F}\u200D\u2642\uFE0F","\u{1F574}","\u{1F469}\u200D\u{1F9BD}","\u{1F9D1}\u200D\u{1F9BD}","\u{1F468}\u200D\u{1F9BD}","\u{1F469}\u200D\u{1F9BC}","\u{1F9D1}\u200D\u{1F9BC}","\u{1F468}\u200D\u{1F9BC}","\u{1F6B6}\u200D\u2640\uFE0F","\u{1F6B6}","\u{1F6B6}\u200D\u2642\uFE0F","\u{1F469}\u200D\u{1F9AF}","\u{1F9D1}\u200D\u{1F9AF}","\u{1F468}\u200D\u{1F9AF}","\u{1F9CE}\u200D\u2640\uFE0F","\u{1F9CE}","\u{1F9CE}\u200D\u2642\uFE0F","\u{1F3C3}\u200D\u2640\uFE0F","\u{1F3C3}","\u{1F3C3}\u200D\u2642\uFE0F","\u{1F9CD}\u200D\u2640\uFE0F","\u{1F9CD}","\u{1F9CD}\u200D\u2642\uFE0F","\u{1F46B}","\u{1F469}\u200D\u2764\uFE0F\u200D\u{1F468}","\u{1F469}\u200D\u2764\uFE0F\u200D\u{1F48B}\u200D\u{1F468}","\u{1F468}\u200D\u{1F469}\u200D\u{1F466}","\u{1F468}\u200D\u{1F469}\u200D\u{1F467}","\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466}","\u{1F468}\u200D\u{1F469}\u200D\u{1F466}\u200D\u{1F466}","\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F467}","\u{1F468}\u200D\u{1F466}","\u{1F468}\u200D\u{1F466}\u200D\u{1F466}","\u{1F468}\u200D\u{1F467}","\u{1F468}\u200D\u{1F467}\u200D\u{1F466}","\u{1F468}\u200D\u{1F467}\u200D\u{1F467}","\u{1F469}\u200D\u{1F466}","\u{1F469}\u200D\u{1F466}\u200D\u{1F466}","\u{1F469}\u200D\u{1F467}","\u{1F469}\u200D\u{1F467}\u200D\u{1F466}","\u{1F469}\u200D\u{1F467}\u200D\u{1F467}","\u{1F5E3}","\u{1F464}","\u{1F465}","\u{1F302}","\u2602\uFE0F","\u{1F9F5}","\u{1FAA1}","\u{1FAA2}","\u{1F9F6}","\u{1F453}","\u{1F576}","\u{1F97D}","\u{1F97C}","\u{1F9BA}","\u{1F454}","\u{1F455}","\u{1F456}","\u{1F9E3}","\u{1F9E4}","\u{1F9E5}","\u{1F9E6}","\u{1F457}","\u{1F458}","\u{1F97B}","\u{1FA71}","\u{1FA72}","\u{1FA73}","\u{1F459}","\u{1F45A}","\u{1F45B}","\u{1F45C}","\u{1F45D}","\u{1F392}","\u{1F45E}","\u{1F45F}","\u{1F97E}","\u{1F97F}","\u{1F460}","\u{1F461}","\u{1FA70}","\u{1F462}","\u{1F451}","\u{1F452}","\u{1F3A9}","\u{1F393}","\u{1F9E2}","\u{1F484}","\u{1F48D}","\u{1F4BC}","\u{1F44B}\u{1F3FB}","\u{1F91A}\u{1F3FB}","\u{1F590}\u{1F3FB}","\u270B\u{1F3FB}","\u{1F596}\u{1F3FB}","\u{1F44C}\u{1F3FB}","\u{1F90F}\u{1F3FB}","\u270C\u{1F3FB}","\u{1F91E}\u{1F3FB}","\u{1F91F}\u{1F3FB}","\u{1F918}\u{1F3FB}","\u{1F919}\u{1F3FB}","\u{1F448}\u{1F3FB}","\u{1F449}\u{1F3FB}","\u{1F446}\u{1F3FB}","\u{1F595}\u{1F3FB}","\u{1F447}\u{1F3FB}","\u261D\u{1F3FB}","\u{1F44D}\u{1F3FB}","\u{1F44E}\u{1F3FB}","\u270A\u{1F3FB}","\u{1F44A}\u{1F3FB}","\u{1F91B}\u{1F3FB}","\u{1F91C}\u{1F3FB}","\u{1F44F}\u{1F3FB}","\u{1F64C}\u{1F3FB}","\u{1F450}\u{1F3FB}","\u{1F932}\u{1F3FB}","\u{1F64F}\u{1F3FB}","\u270D\u{1F3FB}","\u{1F485}\u{1F3FB}","\u{1F933}\u{1F3FB}","\u{1F4AA}\u{1F3FB}","\u{1F9B5}\u{1F3FB}","\u{1F9B6}\u{1F3FB}","\u{1F442}\u{1F3FB}","\u{1F9BB}\u{1F3FB}","\u{1F443}\u{1F3FB}","\u{1F476}\u{1F3FB}","\u{1F467}\u{1F3FB}","\u{1F9D2}\u{1F3FB}","\u{1F466}\u{1F3FB}","\u{1F469}\u{1F3FB}","\u{1F9D1}\u{1F3FB}","\u{1F468}\u{1F3FB}","\u{1F469}\u{1F3FB}\u200D\u{1F9B1}","\u{1F468}\u{1F3FB}\u200D\u{1F9B1}","\u{1F469}\u{1F3FB}\u200D\u{1F9B0}","\u{1F468}\u{1F3FB}\u200D\u{1F9B0}","\u{1F471}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F471}\u{1F3FB}","\u{1F471}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F469}\u{1F3FB}\u200D\u{1F9B3}","\u{1F468}\u{1F3FB}\u200D\u{1F9B3}","\u{1F469}\u{1F3FB}\u200D\u{1F9B2}","\u{1F468}\u{1F3FB}\u200D\u{1F9B2}","\u{1F9D4}\u{1F3FB}","\u{1F475}\u{1F3FB}","\u{1F9D3}\u{1F3FB}","\u{1F474}\u{1F3FB}","\u{1F472}\u{1F3FB}","\u{1F473}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F473}\u{1F3FB}","\u{1F473}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F9D5}\u{1F3FB}","\u{1F46E}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F46E}\u{1F3FB}","\u{1F46E}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F477}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F477}\u{1F3FB}","\u{1F477}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F482}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F482}\u{1F3FB}","\u{1F482}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F575}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F575}\u{1F3FB}","\u{1F575}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F469}\u{1F3FB}\u200D\u2695\uFE0F","\u{1F647}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F647}\u{1F3FB}","\u{1F647}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F481}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F481}\u{1F3FB}","\u{1F481}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F645}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F645}\u{1F3FB}","\u{1F645}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F646}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F646}\u{1F3FB}","\u{1F646}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F64B}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F64B}\u{1F3FB}","\u{1F64B}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F9CF}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F9CF}\u{1F3FB}","\u{1F9CF}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F926}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F926}\u{1F3FB}","\u{1F926}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F937}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F937}\u{1F3FB}","\u{1F937}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F64E}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F64E}\u{1F3FB}","\u{1F64E}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F64D}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F64D}\u{1F3FB}","\u{1F64D}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F487}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F487}\u{1F3FB}","\u{1F487}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F486}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F486}\u{1F3FB}","\u{1F486}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F9D6}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F9D6}\u{1F3FB}","\u{1F9D6}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F483}\u{1F3FB}","\u{1F57A}\u{1F3FB}","\u{1F574}\u{1F3FB}","\u{1F469}\u{1F3FB}\u200D\u{1F9BD}","\u{1F468}\u{1F3FB}\u200D\u{1F9BD}","\u{1F469}\u{1F3FB}\u200D\u{1F9BC}","\u{1F468}\u{1F3FB}\u200D\u{1F9BC}","\u{1F6B6}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F6B6}\u{1F3FB}","\u{1F6B6}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F469}\u{1F3FB}\u200D\u{1F9AF}","\u{1F468}\u{1F3FB}\u200D\u{1F9AF}","\u{1F9CE}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F9CE}\u{1F3FB}","\u{1F9CE}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F3C3}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F3C3}\u{1F3FB}","\u{1F3C3}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F9CD}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F9CD}\u{1F3FB}","\u{1F9CD}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F46D}\u{1F3FB}","\u{1F9D1}\u{1F3FB}\u200D\u{1F91D}\u200D\u{1F9D1}\u{1F3FB}","\u{1F46C}\u{1F3FB}","\u{1F46B}\u{1F3FB}","\u{1F9D7}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F9D7}\u{1F3FB}","\u{1F9D7}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F3C7}\u{1F3FB}","\u{1F3C2}\u{1F3FB}","\u{1F3CC}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F3CC}\u{1F3FB}","\u{1F3CC}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F3C4}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F3C4}\u{1F3FB}","\u{1F3C4}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F6A3}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F6A3}\u{1F3FB}","\u{1F6A3}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F3CA}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F3CA}\u{1F3FB}","\u{1F3CA}\u{1F3FB}\u200D\u2642\uFE0F","\u26F9\u{1F3FB}\u200D\u2640\uFE0F","\u26F9\u{1F3FB}","\u26F9\u{1F3FB}\u200D\u2642\uFE0F","\u{1F3CB}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F3CB}\u{1F3FB}","\u{1F3CB}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F6B4}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F6B4}\u{1F3FB}","\u{1F6B4}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F6B5}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F6B5}\u{1F3FB}","\u{1F6B5}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F938}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F938}\u{1F3FB}","\u{1F938}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F93D}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F93D}\u{1F3FB}","\u{1F93D}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F93E}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F93E}\u{1F3FB}","\u{1F93E}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F939}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F939}\u{1F3FB}","\u{1F939}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F9D8}\u{1F3FB}\u200D\u2640\uFE0F","\u{1F9D8}\u{1F3FB}","\u{1F9D8}\u{1F3FB}\u200D\u2642\uFE0F","\u{1F6C0}\u{1F3FB}","\u{1F6CC}\u{1F3FB}","\u{1F34F}","\u{1F34E}","\u{1F350}","\u{1F34A}","\u{1F34B}","\u{1F34C}","\u{1F349}","\u{1F347}","\u{1F353}","\u{1F348}","\u{1F352}","\u{1F351}","\u{1F96D}","\u{1F34D}","\u{1F965}","\u{1F95D}","\u{1F345}","\u{1F346}","\u{1F951}","\u{1F966}","\u{1F96C}","\u{1F952}","\u{1F336}","\u{1F33D}","\u{1F955}","\u{1F9C4}","\u{1F9C5}","\u{1F954}","\u{1F360}","\u{1F950}","\u{1F96F}","\u{1F35E}","\u{1F956}","\u{1F968}","\u{1F9C0}","\u{1F95A}","\u{1F373}","\u{1F9C8}","\u{1F95E}","\u{1F9C7}","\u{1F953}","\u{1F969}","\u{1F357}","\u{1F356}","\u{1F9B4}","\u{1F32D}","\u{1F354}","\u{1F35F}","\u{1F355}","\u{1F96A}","\u{1F959}","\u{1F9C6}","\u{1F32E}","\u{1F32F}","\u{1F957}","\u{1F958}","\u{1F96B}","\u{1F35D}","\u{1F35C}","\u{1F372}","\u{1F35B}","\u{1F363}","\u{1F371}","\u{1F95F}","\u{1F9AA}","\u{1F364}","\u{1F359}","\u{1F35A}","\u{1F358}","\u{1F365}","\u{1F960}","\u{1F96E}","\u{1F362}","\u{1F361}","\u{1F367}","\u{1F368}","\u{1F366}","\u{1F967}","\u{1F9C1}","\u{1F370}","\u{1F382}","\u{1F36E}","\u{1F36D}","\u{1F36C}","\u{1F36B}","\u{1F37F}","\u{1F369}","\u{1F36A}","\u{1F330}","\u{1F95C}","\u{1F36F}","\u{1F95B}","\u{1F37C}","\u2615\uFE0F","\u{1F375}","\u{1F9C3}","\u{1F964}","\u{1F9CB}","\u{1F376}","\u{1F37A}","\u{1F37B}","\u{1F942}","\u{1F377}","\u{1F943}","\u{1F378}","\u{1F379}","\u{1F9C9}","\u{1F37E}","\u{1F9CA}","\u{1F944}","\u{1F374}","\u{1F37D}","\u{1F963}","\u{1F961}","\u{1F962}","\u{1F9C2}","\u2764\uFE0F","\u{1F9E1}","\u{1F49B}","\u{1F49A}","\u{1F499}","\u{1F49C}","\u{1F5A4}","\u{1F90D}","\u{1F90E}","\u{1F494}","\u2763\uFE0F","\u{1F495}","\u{1F49E}","\u{1F493}","\u{1F497}","\u{1F496}","\u{1F498}","\u{1F49D}","\u{1F49F}","\u262E\uFE0F","\u271D\uFE0F","\u262A\uFE0F","\u{1F549}","\u2638\uFE0F","\u2721\uFE0F","\u{1F52F}","\u{1F54E}","\u262F\uFE0F","\u2626\uFE0F","\u{1F6D0}","\u26CE","\u2648\uFE0F","\u2649\uFE0F","\u264A\uFE0F","\u264B\uFE0F","\u264C\uFE0F","\u264D\uFE0F","\u264E\uFE0F","\u264F\uFE0F","\u2650\uFE0F","\u2651\uFE0F","\u2652\uFE0F","\u2653\uFE0F","\u{1F194}","\u269B\uFE0F","\u{1F251}","\u2622\uFE0F","\u2623\uFE0F","\u{1F4F4}","\u{1F4F3}","\u{1F236}","\u{1F21A}\uFE0F","\u{1F238}","\u{1F23A}","\u{1F237}\uFE0F","\u2734\uFE0F","\u{1F19A}","\u{1F4AE}","\u{1F250}","\u3299\uFE0F","\u3297\uFE0F","\u{1F234}","\u{1F235}","\u{1F239}","\u{1F232}","\u{1F170}\uFE0F","\u{1F171}\uFE0F","\u{1F18E}","\u{1F191}","\u{1F17E}\uFE0F","\u{1F198}","\u274C","\u2B55\uFE0F","\u{1F6D1}","\u26D4\uFE0F","\u{1F4DB}","\u{1F6AB}","\u{1F4AF}","\u{1F4A2}","\u2668\uFE0F","\u{1F6B7}","\u{1F6AF}","\u{1F6B3}","\u{1F6B1}","\u{1F51E}","\u{1F4F5}","\u{1F6AD}","\u2757\uFE0F","\u2755","\u2753","\u2754","\u203C\uFE0F","\u2049\uFE0F","\u{1F505}","\u{1F506}","\u303D\uFE0F","\u26A0\uFE0F","\u{1F6B8}","\u{1F531}","\u269C\uFE0F","\u{1F530}","\u267B\uFE0F","\u2705","\u{1F22F}\uFE0F","\u{1F4B9}","\u2747\uFE0F","\u2733\uFE0F","\u274E","\u{1F310}","\u{1F4A0}","\u24C2\uFE0F","\u{1F300}","\u{1F4A4}","\u{1F3E7}","\u{1F6BE}","\u267F\uFE0F","\u{1F17F}\uFE0F","\u{1F233}","\u{1F202}\uFE0F","\u{1F6C2}","\u{1F6C3}","\u{1F6C4}","\u{1F6C5}","\u{1F6B9}","\u{1F6BA}","\u{1F6BC}","\u26A7","\u{1F6BB}","\u{1F6AE}","\u{1F3A6}","\u{1F4F6}","\u{1F201}","\u{1F523}","\u{1F524}","\u{1F521}","\u{1F520}","\u{1F196}","\u{1F197}","\u{1F199}","\u{1F192}","\u{1F195}","\u{1F193}","0\uFE0F\u20E3","1\uFE0F\u20E3","2\uFE0F\u20E3","3\uFE0F\u20E3","4\uFE0F\u20E3","5\uFE0F\u20E3","6\uFE0F\u20E3","7\uFE0F\u20E3","8\uFE0F\u20E3","9\uFE0F\u20E3","\u{1F51F}","\u{1F522}","#\uFE0F\u20E3","*\uFE0F\u20E3","\u23CF\uFE0F","\u25B6\uFE0F","\u23F8","\u23EF","\u23F9","\u23FA","\u23ED","\u23EE","\u23E9","\u23EA","\u23EB","\u23EC","\u25C0\uFE0F","\u{1F53C}","\u{1F53D}","\u27A1\uFE0F","\u2B05\uFE0F","\u2B06\uFE0F","\u2B07\uFE0F","\u2197\uFE0F","\u2198\uFE0F","\u2199\uFE0F","\u2196\uFE0F","\u2195\uFE0F","\u2194\uFE0F","\u21AA\uFE0F","\u21A9\uFE0F","\u2934\uFE0F","\u2935\uFE0F","\u{1F500}","\u{1F501}","\u{1F502}","\u{1F504}","\u{1F503}","\u{1F3B5}","\u{1F3B6}","\u2795","\u2796","\u2797","\u2716\uFE0F","\u{1F4B2}","\u{1F4B1}","\u3030\uFE0F","\u27BF","\u{1F51A}","\u{1F519}","\u{1F51B}","\u{1F51D}","\u{1F51C}","\u2714\uFE0F","\u2611\uFE0F","\u{1F518}","\u{1F534}","\u{1F7E0}","\u{1F7E1}","\u{1F7E2}","\u{1F535}","\u{1F7E3}","\u26AB\uFE0F","\u26AA\uFE0F","\u{1F7E4}","\u{1F53A}","\u{1F53B}","\u{1F538}","\u{1F539}","\u{1F536}","\u{1F537}","\u{1F533}","\u{1F532}","\u{1F7E5}","\u{1F7E7}","\u{1F7E8}","\u{1F7E9}","\u{1F7E6}","\u{1F7EA}","\u2B1B\uFE0F","\u2B1C\uFE0F","\u{1F7EB}","\u{1F508}","\u{1F507}","\u{1F509}","\u{1F50A}","\u{1F514}","\u{1F515}","\u{1F4E3}","\u{1F4E2}","\u{1F441}\u200D\u{1F5E8}","\u{1F4AC}","\u{1F4AD}","\u{1F0CF}","\u{1F3B4}","\u{1F004}\uFE0F","\u{1F550}","\u{1F551}","\u{1F552}","\u{1F553}","\u{1F554}","\u{1F555}","\u{1F556}","\u{1F557}","\u{1F558}","\u{1F559}","\u{1F55A}","\u{1F55B}","\u{1F55C}","\u{1F55D}","\u{1F55E}","\u{1F55F}","\u{1F560}","\u{1F561}","\u{1F562}","\u{1F563}","\u{1F564}","\u{1F565}","\u{1F566}","\u{1F567}"];
            saved_emojis = "";
            if ( document.getElementsByClassName( "emoji-input" )[ 0 ] ) {
                saved_emojis = document.getElementsByClassName( "emoji-input" )[ 0 ].value;
            }
            document.getElementById( "modal" ).innerHTML = "";
            document.getElementById( "modal" ).innerHTML += `<input class="emoji-input" type="text" value=${saved_emojis}><button class="emoji-submit" onclick="closeEmojiModal();">Select</button><div>`;
            var i = start; for ( ; i<start + 49; i++ ) {
                var html = `<a class="emoji-in-modal" onclick="selectEmoji( '${emojis[ i ]}' )">${emojis[ i ]}</a>`
                document.getElementById( "modal" ).innerHTML += html;
            }
            document.getElementById( "modal" ).innerHTML += '</div><div id="modal-btns"></div>'
            var backStyle = "";
            var backClick = "";
            var fwdStyle = "";
            var fwdClick = "";
            if ( i == 49 ) {
                backStyle = `style="background-color: #999"`;
            } else {
                backClick = `onclick="showEmojis( ${i - 98} )"`;
            }
            if ( i == 980 ) {
                fwdStyle = `style="background-color: #999"`;
            } else {
                fwdClick = `onclick="showEmojis( ${i} )"`;
            }
            var btns = `<button class="modal-btn" ${backStyle} ${backClick}>Back</button><button class="modal-btn" ${fwdStyle} ${fwdClick}>Next</button>`
            document.getElementById( "modal-btns" ).innerHTML = btns;
            document.getElementById( "black-bg" ).style.display = "block";
            document.getElementById( "modal" ).style.display = "block";
        }
        function selectEmoji( emoji ) {
            document.getElementsByClassName( "emoji-input" )[ 0 ].value += emoji;
        }
        function closeEmojiModal() {
            document.getElementsByClassName( "message-form" )[ 0 ].getElementsByTagName( "textarea" )[ 0 ].value += document.getElementsByClassName( "emoji-input" )[ 0 ].value;
            document.getElementsByClassName( "emoji-input" )[ 0 ].value = "";
            modalVanish();
        }
        function modalVanish() {
            document.getElementById( "black-bg" ).style.display = "none";
            document.getElementById( "modal" ).style.display = "none";
        }
    </script>
    <script>
        dragElement(document.getElementById("vidDiv"));

        function dragElement(elmnt) {
          var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
          if (document.getElementById(elmnt.id + "header")) {
            // if present, the header is where you move the DIV from:
            document.getElementById(elmnt.id + "header").onpointerdown = dragMouseDown;
          } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onpointerdown = dragMouseDown;
          }

          function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onpointerup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onpointermove = elementDrag;
          }

          function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            document.getElementById("vidDiv").style.bottom = "auto";
            document.getElementById("vidDiv").style.right = "auto";
          }

          function closeDragElement() {
            // stop moving when mouse button is released:
            document.onpointerup = null;
            document.onpointermove = null;
          }
        }
    </script>
    <script>
        function moveVid( wrapper ) {
            wrapper.getElementsByTagName( "iframe" )[ 0 ].src = wrapper.getElementsByTagName( "iframe" )[ 0 ].src;
            document.getElementById( "vidDiv" ).getElementsByTagName( "div" )[ 1 ].innerHTML += wrapper.innerHTML;
            document.getElementById( "vidDiv" ).getElementsByClassName( "ratio" )[ 0 ].style.maxWidth = "500px";
            document.getElementById( "vidDiv" ).style.display = "inline-block";
            if ( window.innerWidth < 601 ) {

                document.getElementsByClassName( "inner-vid" )[ 0 ].getElementsByClassName( "ratio" )[ 0 ].style.maxWidth = "190px";
                document.getElementsByClassName( "minmax" )[ 0 ].remove();
                document.getElementById( "vidDiv" ).style.position = "absolute";
                document.getElementById( "vidDiv" ).style.left = "100px";
            }
        }
    </script>
    <script>
        function convertRGBtoHex( rgb ) {
            var a = rgb.split("(")[1].split(")")[0];
            a = a.split(",");
            var b = a.map(function(x){             //For each array element
                x = parseInt(x).toString(16);      //Convert to a base16 string
                return (x.length==1) ? "0"+x : x;  //Add zero if we get only one character
            })
            b = "#"+b.join("");
            return b.substring( 0, 7 );
        }
        function padZero(str, len) {
            len = len || 2;
            var zeros = new Array(len).join('0');
            return (zeros + str).slice(-len);
        }
        function invertColor(hex, bw) {
            if (hex.indexOf('#') === 0) {
                hex = hex.slice(1);
            }
            // convert 3-digit hex to 6-digits.
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            if (hex.length !== 6) {
                throw new Error(`${t('invalidHexColor')}`);
            }
            var r = parseInt(hex.slice(0, 2), 16),
                g = parseInt(hex.slice(2, 4), 16),
                b = parseInt(hex.slice(4, 6), 16);
            if (bw) {
                // https://stackoverflow.com/a/3943023/112731
                return (r * 0.299 + g * 0.587 + b * 0.114) > 186
                    ? '#000000'
                    : '#FFFFFF';
            }
            // invert color components
            r = (255 - r).toString(16);
            g = (255 - g).toString(16);
            b = (255 - b).toString(16);
            // pad each with zeros and return
            return "#" + padZero(r) + padZero(g) + padZero(b);
        }
    </script>
    <script>
        function createQR( content ) {
            var dataUriPngImage = document.createElement( 'img' );
            s = QRCode.generatePNG( content, {
                ecclevel: 'M',
                format: 'html',
                fillcolor: '#FFFFFF',
                textcolor: '#373737',
                margin: 4,
                modulesize: 8,
            });
            dataUriPngImage.src = s;
            dataUriPngImage.style.width = "100%";
            dataUriPngImage.style.maxWidth = "400px";
            dataUriPngImage.className = 'qr_code';
            return dataUriPngImage;
        }
    </script>
    <script>
        function uploadFile() {
            let photo = document.getElementById( "image-file" )[ "files" ][ 0 ];
            if (photo === undefined) {
                console.error("Please choose an image.");
                return;
            }
            let formData = new FormData();
            formData.append( "photo", photo );
            
            document.getElementById( "progressBar" ).value = Math.round(0);
            let imgDiv = null;
            let xhr = new XMLHttpRequest();
            xhr.addEventListener("load", (r) => {
                let statusCode = xhr.status;
                if (statusCode >= 200 && statusCode < 300) {
                    let cid = JSON.parse(r.target.responseText)["Hash"];
                    let imgUrl = "https://nostr.crustapps.net/ipfs/" + cid;
                    document.getElementById( "imgTip" ).style.display = "block";
                    if (imgDiv !== null) imgDiv.setAttribute( "data-img", imgUrl );
                } else {
                    console.error(`Upload file ${photo.name} failed, please try again.`);
                }
            }, false);
            xhr.addEventListener("error", (e) => {
                alert(`Upload file ${photo.name} failed, error:${JSON.stringify(e)}, please try again.`);
                document.getElementById( "uploadStatus" ).innerHTML = "Upload image failed, please try again.";
            });
            xhr.upload.addEventListener("progress", function (e) {
                let percent = (event.loaded / event.total) * 100;
                let uploadContent = "uploaded " + event.loaded + " bytes of " + event.total;
                document.getElementById( "progressBar" ).value = Math.round(percent);
                if (percent === 100) {
                    document.getElementById( "uploadStatus" ).innerHTML = "100% " + uploadContent;
                    imgDiv = showImage("");
                } else {
                    document.getElementById( "uploadStatus" ).innerHTML = Math.round(percent) + "% " + uploadContent;
                }
            });   
            xhr.open("post", "https://nostr.crustapps.net/api/v0/add?pin=true");
            xhr.setRequestHeader("Authorization","Basic Y1RIYVd3em95V1diSGVtSDdHVDJnU3UxN2g0THRpb3FiYnhxaURFQmlSNDlEdnBUTjoweDU4MjNiMmFmOTA4ZTYxYTM0Y2FhNTU3ZTU3ZGRlMWMzNTJhNGUxNTk3OTM4ZmE0YzdiNjYzN2MwMTJiYzYxNDY5Y2U0MTViNGVmZTQzNzNjYWExZWRjYTdkMGI3NDE2MDViMDYwZTBjZmNjNjNmNDVkNjIyNTBjZWVhOWQ3YTgx")
            xhr.send(formData);

            document.getElementById( "uploadStatus" ).innerHTML = "Preparing to upload, please wait...";
            document.getElementById( "uploadDiv" ).style.visibility = "visible";
            document.getElementById( "image-file" ).disabled = true;
            document.getElementById( "image-file-lable" ).style.opacity = 0.65;
            document.getElementById( "image-file-lable" ).style.cursor = "not-allowed";
        }
        function showImgs() {
            if ( localStorage[ "img_cache" ] ) {
                var imgs = JSON.parse( localStorage[ "img_cache" ] );
            } else {
                var imgs = [];
                localStorage[ "img_cache" ] = JSON.stringify( imgs );
            }
            document.getElementById( "modal" ).innerHTML = "";

            let html = `
                <div class="upload-title" style="height:70px">
                <h1>IMAGE UPLOAD</h1>
                </div>
                <form enctype="multipart/form-data" method="post" style="text-align:center">
                    <input type="file" id="image-file" accept="image/*" style="display:none" onchange="uploadFile()" ><br>
                    <label 
                        id="image-file-lable"
                        for="image-file" 
                        style="display: inline-block;
                                width: 140px; 
                                height: 32px;
                                padding: 4px 0px; 
                                margin: 8px; 
                                text-align: center; 
                                line-height: 32px; 
                                color: #ffffff;
                                background: #f44336;
                                border-radius: 5px;
                                cursor: pointer;
                                letter-spacing: 1px;"
                    >
                        select image
                    </label>
                    <div id="uploadDiv" style="visibility:hidden">
                        <progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
                        <p id="uploadStatus">Preparing to upload, please wait...</p>
                    </div>
                    <p id="imgTip" style="font-family:baskerville, serif; font-size:14px;display:${imgs.length === 0 ? 'none' : 'block' }">
                        images:(click to get url)</p>
                </form>
                <div class="gallery-holder" style="overflow-y:auto"></div>
            `;
            document.getElementById( "modal" ).innerHTML = html;
            imgs.forEach(showImage);

            document.getElementById( "black-bg" ).style.display = "block";
            document.getElementById( "modal" ).style.display = "block";
        }
        function showImage(img) {
            var loadingDiv = `
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
                <div class='child-center'></div>
			`;
            var div = document.createElement( "div" );
            div.setAttribute( "data-img", img );
            div.className = "lds-spinner";
            div.innerHTML = loadingDiv;
            div.onclick = function() {
                document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value += this.getAttribute( "data-img" );
                document.getElementById( "black-bg" ).style.display = "none";
                document.getElementById( "modal" ).style.display = "none";
                document.getElementsByClassName( "note-input" )[ 0 ].focus();
                document.getElementsByClassName( "note-input" )[ 0 ].select();
            }
            var imgObj = new Image();
            var tryout = 10;
            imgObj.src = img;
            imgObj.onload = function() {
                for(const i of document.getElementsByClassName( "child-center" )) {
                    i.style.display = "none";
                }
                div.style.backgroundImage = "url(" + div.getAttribute( "data-img" ) + ")";
                document.getElementById( "uploadDiv" ).style.visibility = "hidden";
                document.getElementById( "image-file" ).disabled = false;
                document.getElementById( "image-file-lable" ).style.opacity = 1;
                document.getElementById( "image-file-lable" ).style.cursor = "pointer";
            }
            imgObj.onerror = async function(e) {
                if (--tryout >= 0) {
                    await new Promise(r => setTimeout(r, 3000));
                    imgObj.src = div.getAttribute( "data-img" ) + "?t=" + new Date().getTime();
                } else {
                    document.getElementById( "uploadDiv" ).style.visibility = "hidden";
                    document.getElementById( "image-file" ).disabled = false;
                    document.getElementById( "image-file-lable" ).style.opacity = 1;
                    document.getElementById( "image-file-lable" ).style.cursor = "pointer";
                }
            }
            if (imgObj.complete) imgObj.onload();

            var parentDiv = document.getElementsByClassName( "gallery-holder" )[ 0 ];
            parentDiv.insertBefore(div, parentDiv.firstChild);

            return div;
        }
    </script>
      
</body>
</html>

